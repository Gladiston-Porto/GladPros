(()=>{var e={};e.id=7545,e.ids=[7545],e.modules={1440:(e,t,r)=>{"use strict";r.d(t,{M:()=>c});var o=r(44999),a=r(39916),s=r(48378),i=r(13641),n=r(29979);async function c(){let e=await (0,o.UL)(),t=e.get("authToken")?.value;if(!t)return(0,a.redirect)("/login");try{let e=await (0,s.S)(t),r=await i.z.$queryRaw`
      SELECT id, email, nomeCompleto, tokenVersion, status 
      FROM Usuario 
      WHERE id = ${Number(e.sub)} 
      LIMIT 1
    `;if(!r.length)return(0,a.redirect)("/login?e=user");let o=r[0];if(await (0,n.I)())try{let t=o.tokenVersion??0;if((e.tokenVersion??0)!==t)return(0,a.redirect)("/login?e=tokenver")}catch{}if("ATIVO"!==e.status||"ATIVO"!==o.status)return(0,a.redirect)("/login?e=inactive");return{id:String(e.sub),role:String(e.role??"USUARIO"),email:o.email||void 0,name:o.nomeCompleto||"Usu\xe1rio"}}catch{return(0,a.redirect)("/login?e=token")}}},1708:e=>{"use strict";e.exports=require("node:process")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{"use strict";e.exports=require("node:tty")},8704:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{HTTPAccessErrorStatus:function(){return r},HTTP_ERROR_FALLBACK_ERROR_CODE:function(){return a},getAccessFallbackErrorTypeByStatus:function(){return n},getAccessFallbackHTTPStatus:function(){return i},isHTTPAccessFallbackError:function(){return s}});let r={NOT_FOUND:404,FORBIDDEN:403,UNAUTHORIZED:401},o=new Set(Object.values(r)),a="NEXT_HTTP_ERROR_FALLBACK";function s(e){if("object"!=typeof e||null===e||!("digest"in e)||"string"!=typeof e.digest)return!1;let[t,r]=e.digest.split(";");return t===a&&o.has(Number(r))}function i(e){return Number(e.digest.split(";")[1])}function n(e){switch(e){case 401:return"unauthorized";case 403:return"forbidden";case 404:return"not-found";default:return}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13641:(e,t,r)=>{"use strict";r.d(t,{z:()=>o.z});var o=r(31183)},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29979:(e,t,r)=>{"use strict";r.d(t,{I:()=>i});var o=r(13641);let a=null,s=0;async function i(){let e=Date.now();if(null!==a&&e-s<6e4)return a;try{let t=await o.z.$queryRaw`
      SELECT COUNT(*) AS cnt
      FROM INFORMATION_SCHEMA.COLUMNS
      WHERE TABLE_SCHEMA = DATABASE()
        AND TABLE_NAME = 'Usuario'
        AND COLUMN_NAME = 'tokenVersion'
    `;return a=(t?.[0]?.cnt??0)>0,s=e,a}catch{return a=!1,s=e,!1}}},31162:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"isNextRouterError",{enumerable:!0,get:function(){return s}});let o=r(8704),a=r(49026);function s(e){return(0,a.isRedirectError)(e)||(0,o.isHTTPAccessFallbackError)(e)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},31183:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var o=r(29942);let a=global.__prisma??new o.PrismaClient({log:["error"]})},31421:e=>{"use strict";e.exports=require("node:child_process")},33873:e=>{"use strict";e.exports=require("path")},33911:(e,t,r)=>{"use strict";r.d(t,{db:()=>i});class o{constructor(e){this.proposta={},this.propostaLog={},this.propostaEtapa={},this.propostaMaterial={},this.cliente={},this.usuario={}}$connect(){return Promise.resolve()}$disconnect(){return Promise.resolve()}$transaction(e){return e({})}generatePropostaNumber(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),a=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return Promise.resolve(`PROP-${t}${r}${o}-${a}`)}}let a=globalThis;class s extends o{async generatePropostaNumber(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),a=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`PROP-${t}${r}${o}-${a}`}}let i=a.prisma??new s},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{"use strict";e.exports=require("node:os")},48378:(e,t,r)=>{"use strict";r.d(t,{S:()=>c,z:()=>n});var o=r(87806),a=r(77412);let s=null;function i(){if(!s){let e="g5QZk5uXmGBy1267sLdrd8FHIzUqEtUrxnyJqoWYEqPklmXS1YiLp0ervYW7C017";if(e){if(e.length<32)throw Error("JWT_SECRET deve ter pelo menos 32 caracteres");s=new TextEncoder().encode(e)}else if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE||"phase-development-build"===process.env.NEXT_PHASE)console.warn("[JWT] Usando secret tempor\xe1rio durante build. Certifique-se de definir JWT_SECRET em produ\xe7\xe3o."),s=new TextEncoder().encode("temporary-build-secret-will-be-replaced-at-runtime-32-chars-minimum");else throw Error("Missing JWT_SECRET environment variable. Certifique-se de definir esta vari\xe1vel em .env.local")}return s}async function n(e,t="7d"){return await new o.P({role:e.role,status:e.status,tokenVersion:e.tokenVersion}).setProtectedHeader({alg:"HS256"}).setSubject(e.sub).setIssuer("gladpros").setAudience("gladpros-app").setExpirationTime(t).sign(i())}async function c(e){let{payload:t}=await (0,a.V)(e,i(),{issuer:"gladpros",audience:"gladpros-app"});return t}},49026:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{REDIRECT_ERROR_CODE:function(){return a},RedirectType:function(){return s},isRedirectError:function(){return i}});let o=r(52836),a="NEXT_REDIRECT";var s=function(e){return e.push="push",e.replace="replace",e}({});function i(e){if("object"!=typeof e||null===e||!("digest"in e)||"string"!=typeof e.digest)return!1;let t=e.digest.split(";"),[r,s]=t,i=t.slice(2,-2).join(";"),n=Number(t.at(-2));return r===a&&("replace"===s||"push"===s)&&"string"==typeof i&&!isNaN(n)&&n in o.RedirectStatusCode}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},51455:e=>{"use strict";e.exports=require("node:fs/promises")},51846:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{BailoutToCSRError:function(){return o},isBailoutToCSRError:function(){return a}});let r="BAILOUT_TO_CLIENT_SIDE_RENDERING";class o extends Error{constructor(e){super("Bail out to client-side rendering: "+e),this.reason=e,this.digest=r}}function a(e){return"object"==typeof e&&null!==e&&"digest"in e&&e.digest===r}},52637:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"isPostpone",{enumerable:!0,get:function(){return o}});let r=Symbol.for("react.postpone");function o(e){return"object"==typeof e&&null!==e&&e.$$typeof===r}},52836:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RedirectStatusCode",{enumerable:!0,get:function(){return r}});var r=function(e){return e[e.SeeOther=303]="SeeOther",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e}({});("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{"use strict";e.exports=require("node:fs")},76760:e=>{"use strict";e.exports=require("node:path")},76926:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createDedupedByCallsiteServerErrorLoggerDev",{enumerable:!0,get:function(){return c}});let o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=a(t);if(r&&r.has(e))return r.get(e);var o={__proto__:null},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var n=s?Object.getOwnPropertyDescriptor(e,i):null;n&&(n.get||n.set)?Object.defineProperty(o,i,n):o[i]=e[i]}return o.default=e,r&&r.set(e,o),o}(r(61120));function a(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(a=function(e){return e?r:t})(e)}let s={current:null},i="function"==typeof o.cache?o.cache:e=>e,n=console.warn;function c(e){return function(...t){n(e(...t))}}i(e=>{try{n(s.current)}finally{s.current=null}})},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79881:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>T,routeModule:()=>R,serverHooks:()=>h,workAsyncStorage:()=>S,workUnitAsyncStorage:()=>A});var o={};r.r(o),r.d(o,{GET:()=>x,POST:()=>O,runtime:()=>j});var a=r(96559),s=r(48088),i=r(37719),n=r(32190),c=r(14250),u=r(33911),l=r(24501);let d=l.Ik({id:l.Yj(),codigo:l.Yj().min(1,"C\xf3digo obrigat\xf3rio"),nome:l.Yj().min(1,"Nome obrigat\xf3rio"),quantidade:l.ai().min(0,"Quantidade deve ser positiva"),unidade:l.Yj().min(1,"Unidade obrigat\xf3ria"),preco:l.ai().optional(),status:l.k5(["necessario","opcional","substituivel"]),fornecedor:l.Yj().optional(),obs:l.Yj().optional()}),p=l.Ik({id:l.Yj(),servico:l.Yj().min(1,"Servi\xe7o obrigat\xf3rio"),descricao:l.Yj().min(1,"Descri\xe7\xe3o obrigat\xf3ria"),quantidade:l.ai().optional(),unidade:l.Yj().optional(),duracaoHoras:l.ai().optional(),custoMO:l.ai().optional(),status:l.k5(["planejada","opcional","removida"])}),m=l.Ik({id:l.Yj().min(1,"Cliente obrigat\xf3rio"),contato_nome:l.Yj().min(1,"Nome do contato obrigat\xf3rio"),contato_email:l.Yj().email("E-mail inv\xe1lido"),contato_telefone:l.Yj().optional(),local_endereco:l.Yj().min(1,"Endere\xe7o obrigat\xf3rio"),titulo:l.Yj().min(1,"T\xedtulo obrigat\xf3rio")}),f=l.Ik({tempo_para_aceite:l.ai().min(1,"Tempo para aceite deve ser positivo"),validade_proposta:l.Yj().min(1,"Validade obrigat\xf3ria"),prazo_execucao_dias:l.ai().min(1,"Prazo de execu\xe7\xe3o deve ser positivo"),janela:l.Yj().optional(),restricoes:l.Yj().optional()}),g=l.Ik({condicoes_pagamento:l.Yj().min(1,"Condi\xe7\xf5es de pagamento obrigat\xf3rias"),garantia:l.Yj().min(1,"Garantia obrigat\xf3ria"),exclusoes:l.Yj().min(1,"Exclus\xf5es obrigat\xf3rias"),condicoes_gerais:l.Yj().min(1,"Condi\xe7\xf5es gerais obrigat\xf3rias"),desconto:l.ai().min(0).max(100,"Desconto deve estar entre 0 e 100%")}),E=l.Ik({custo_material:l.ai().min(0),custo_mo:l.ai().min(0),horas_mo:l.ai().min(0),custo_terceiros:l.ai().min(0),overhead_pct:l.ai().min(0).max(100),margem_pct:l.ai().min(0).max(100),impostos_pct:l.ai().min(0).max(100),contingencia_pct:l.ai().min(0).max(100),frete:l.ai().min(0)}),v=l.Ik({gatilho:l.k5(["na_aprovacao","por_marcos","na_entrega","custom"]),percentual_sinal:l.ai().min(0).max(100),forma_preferida:l.Yj().min(1,"Forma de pagamento obrigat\xf3ria"),instrucoes:l.Yj().optional()}),_=l.Ik({cliente:m,escopo:l.Yj().min(10,"Escopo deve ter pelo menos 10 caracteres"),prazos:f,permite:l.k5(["NECESSARIO","NAO_NECESSARIO","OBTIDO"]),quaisPermites:l.Yj().optional(),normas:l.Yj().optional(),inspecoes:l.Yj().optional(),materiais:l.YO(d),etapas:l.YO(p),comerciais:g,interno:E,faturamento:v,obsCliente:l.Yj().optional(),obsInternas:l.Yj().optional(),status:l.k5(["RASCUNHO","PENDENTE_APROVACAO","APROVADA","REJEITADA","CANCELADA","ENVIADA","ASSINADA"])});var b=r(1440);let j="nodejs";function P(){return"phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE}async function y(e,t=2,r=300){let o;for(let a=0;a<=t;a++)try{return await e()}catch(s){let e=s?.code||s?.errorCode;if("PrismaClientInitializationError"!==s?.name&&"P1001"!==e||a===t)throw s;o=s,await new Promise(e=>setTimeout(e,r))}throw o}async function x(){if(P())return n.NextResponse.json({error:"Service temporarily unavailable"},{status:503});try{return n.NextResponse.json({items:[],pagination:{total:0,hasNext:!1,nextCursor:null,pageSize:10}})}catch{return n.NextResponse.json({error:"INTERNAL_ERROR",message:"Erro interno do servidor"},{status:500})}}async function O(e){if(P())return n.NextResponse.json({error:"Service temporarily unavailable"},{status:503});try{let t=await (0,b.M)();if(!t)return n.NextResponse.json({error:"UNAUTHORIZED",message:"Usu\xe1rio n\xe3o autenticado"},{status:401});let r=await e.json(),o=_.parse(r),a=function(e){let t=e.materiais.reduce((e,t)=>e+(t.preco??0)*t.quantidade,0),r=e.interno.custo_mo,o=e.interno.custo_terceiros,a=e.interno.frete,s=t+r+o+a,i=s*(e.interno.overhead_pct/100),n=(s+i)*(e.interno.margem_pct/100),c=(s+i+n)*(e.interno.contingencia_pct/100),u=s+i+n+c,l=u*(e.interno.impostos_pct/100),d=u+l;return{clienteId:parseInt(e.cliente.id),titulo:e.cliente.titulo,descricao:e.escopo,valorEstimado:d,status:e.status,contatoNome:e.cliente.contato_nome,contatoEmail:e.cliente.contato_email,contatoTelefone:e.cliente.contato_telefone||void 0,localExecucaoEndereco:e.cliente.local_endereco,tempoParaAceite:e.prazos.tempo_para_aceite,validadeProposta:new Date(e.prazos.validade_proposta),prazoExecucaoDias:e.prazos.prazo_execucao_dias,janelaExecucao:e.prazos.janela,restricoesAcesso:e.prazos.restricoes,permite:e.permite,quaisPermites:e.quaisPermites,normasReferencia:e.normas,inspecoesNecessarias:e.inspecoes,condicoesPagamento:e.comerciais.condicoes_pagamento,garantia:e.comerciais.garantia,exclusoes:e.comerciais.exclusoes,condicoesGerais:e.comerciais.condicoes_gerais,estimativasInternas:{custoMaterialEstimado:t,custoMaoObraEstimado:r,horasMaoObraEstimadas:e.interno.horas_mo,custoTerceirosEstimado:o,overheadPercentual:e.interno.overhead_pct,margemDesejadaPercentual:e.interno.margem_pct,impostosPercentual:e.interno.impostos_pct,contingenciaPercentual:e.interno.contingencia_pct,freteLogisticaEstimado:a,totalEstimadoInterno:d},gatilhoFaturamento:e.faturamento.gatilho.toUpperCase(),percentualSinal:e.faturamento.percentual_sinal,formaPreferida:e.faturamento.forma_preferida,instrucoesFaturamento:e.faturamento.instrucoes,observacoesCliente:e.obsCliente,observacoesInternas:e.obsInternas,materiais:e.materiais.map(e=>({codigo:String(e.codigo??""),nome:String(e.nome??""),quantidade:e.quantidade,unidade:String(e.unidade??""),valorUnitarioEstimado:e.preco,status:String(e.status??"")?.toUpperCase(),fornecedor:e.fornecedor?String(e.fornecedor):void 0,observacoes:e.obs?String(e.obs):void 0})),etapas:e.etapas.map((e,t)=>({servico:String(e.servico??""),descricao:String(e.descricao??""),ordem:t+1,quantidade:e.quantidade,unidade:e.unidade?String(e.unidade):void 0,duracaoEstimadaHoras:e.duracaoHoras,custoMaoObraEstimado:e.custoMO,status:e.status?String(e.status).toUpperCase():"PLANEJADA"}))}}(o),s=await y(async()=>{let e=await u.db.generatePropostaNumber();return{id:Math.floor(1e4*Math.random())+1e3,numeroProposta:e,titulo:a.titulo,descricao:a.descricao,status:a.status,valorEstimado:a.valorEstimado,clienteId:a.clienteId,usuarioId:t.id,contatoNome:a.contatoNome,contatoEmail:a.contatoEmail,contatoTelefone:a.contatoTelefone,localExecucaoEndereco:a.localExecucaoEndereco,tempoParaAceite:a.tempoParaAceite,validadeProposta:a.validadeProposta,prazoExecucaoDias:a.prazoExecucaoDias,janelaExecucao:a.janelaExecucao,restricoesAcesso:a.restricoesAcesso,permite:a.permite,quaisPermites:a.quaisPermites,normasReferencia:a.normasReferencia,inspecoesNecessarias:a.inspecoesNecessarias,condicoesPagamento:a.condicoesPagamento,garantia:a.garantia,exclusoes:a.exclusoes,condicoesGerais:a.condicoesGerais,observacoesCliente:a.observacoesCliente,observacoesInternas:a.observacoesInternas,estimativasInternas:a.estimativasInternas,materiais:a.materiais,etapas:a.etapas,criadoEm:new Date,atualizadoEm:new Date}});return n.NextResponse.json({success:!0,message:"Proposta criada com sucesso",proposta:{id:s.id,numeroProposta:s.numeroProposta,titulo:s.titulo,status:s.status,valorEstimado:s.valorEstimado,criadoEm:s.criadoEm}},{status:201})}catch(t){if(t instanceof c.G)return n.NextResponse.json({error:"VALIDATION_ERROR",message:"Dados inv\xe1lidos",details:t.issues.map(e=>({field:e.path.join("."),message:e.message}))},{status:400});let e=function(e){let t=e.meta;return"P2002"===e.code?"numeroProposta"===t?.target?.[0]?{status:409,message:"N\xfamero da proposta j\xe1 existe"}:{status:409,message:"Viola\xe7\xe3o de restri\xe7\xe3o \xfanica"}:"P2025"===e.code?{status:404,message:"Registro n\xe3o encontrado"}:{status:500,message:"Erro interno do servidor"}}(t);return n.NextResponse.json({error:"DATABASE_ERROR",message:e.message},{status:e.status})}}let R=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/propostas/route",pathname:"/api/propostas",filename:"route",bundlePath:"app/api/propostas/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\propostas\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:S,workUnitAsyncStorage:A,serverHooks:h}=R;function T(){return(0,i.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:A})}},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[7719,580,9942,4501,4553,6994],()=>r(79881));module.exports=o})();