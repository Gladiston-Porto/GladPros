"use strict";(()=>{var e={};e.id=7758,e.ids=[7758],e.modules={1708:e=>{e.exports=require("node:process")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{e.exports=require("node:tty")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{e.exports=require("assert")},14985:e=>{e.exports=require("dns")},16698:e=>{e.exports=require("node:async_hooks")},21820:e=>{e.exports=require("os")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31421:e=>{e.exports=require("node:child_process")},33873:e=>{e.exports=require("path")},34631:e=>{e.exports=require("tls")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{e.exports=require("node:os")},51455:e=>{e.exports=require("node:fs/promises")},53501:(e,t,r)=>{r.d(t,{q:()=>a});var i=r(55511),s=r.n(i),o=r(13641);class a{static get delegate(){try{return o.z.codigoMFA}catch{return}}static generateCode(){return Math.floor(1e5+9e5*Math.random()).toString()}static hashCode(e){return s().createHash("sha256").update(e).digest("hex")}static async createMFACode({usuarioId:e,tipoAcao:t="LOGIN",ip:r,userAgent:i}){this.delegate?.deleteMany?await this.delegate.deleteMany({where:{usuarioId:e,tipoAcao:t,OR:[{usado:!0},{expiresAt:{lt:new Date}}]}}):await o.z.$executeRaw`
        DELETE FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND (usado = TRUE OR expiresAt < NOW())
      `;let s=this.generateCode(),a=this.hashCode(s),n=new Date(Date.now()+3e5);if(this.delegate?.create)return{code:s,id:(await this.delegate.create({data:{usuarioId:e,codigo:a,tipoAcao:t,expiresAt:n,usado:!1,ip:r,userAgent:i},select:{id:!0}})).id};{await o.z.$executeRaw`
        INSERT INTO CodigoMFA (usuarioId, codigo, tipoAcao, expiresAt, ip, userAgent)
        VALUES (${e}, ${a}, ${t}, ${n}, ${r}, ${i})
      `;let d=await o.z.$queryRaw`
        SELECT id FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND usado = FALSE
        ORDER BY criadoEm DESC
        LIMIT 1
      `;return{code:s,id:d[0]?.id||0}}}static async verifyMFACode({usuarioId:e,code:t,tipoAcao:r="LOGIN"}){let i=this.hashCode(t),s=this.delegate?.findFirst?await this.delegate.findFirst({where:{usuarioId:e,codigo:i,tipoAcao:r},orderBy:{criadoEm:"desc"},select:{id:!0,expiresAt:!0,usado:!0}}):(await o.z.$queryRaw`
          SELECT id, expiresAt, usado
          FROM CodigoMFA
          WHERE usuarioId = ${e}
          AND codigo = ${i}
          AND tipoAcao = ${r}
          ORDER BY criadoEm DESC
          LIMIT 1
        `)[0];return s?s.usado?{valid:!1,error:"C\xf3digo j\xe1 foi utilizado"}:new Date>s.expiresAt?{valid:!1,error:"C\xf3digo expirado"}:(this.delegate?.update?await this.delegate.update({where:{id:s.id},data:{usado:!0}}):await o.z.$executeRaw`
        UPDATE CodigoMFA SET usado = TRUE WHERE id = ${s.id}
      `,{valid:!0,codeId:s.id}):{valid:!1,error:"C\xf3digo inv\xe1lido"}}static async cleanupExpiredCodes(){return this.delegate?.deleteMany?(await this.delegate.deleteMany({where:{OR:[{usado:!0},{expiresAt:{lt:new Date}}]}})).count:Number(await o.z.$executeRaw`
        DELETE FROM CodigoMFA 
        WHERE expiresAt < NOW() OR usado = TRUE
      `)}static async countRecentAttempts(e,t=15){let r=new Date(Date.now()-60*t*1e3);if(this.delegate?.count)return await this.delegate.count({where:{usuarioId:e,criadoEm:{gt:r}}});{let t=await o.z.$queryRaw`
        SELECT COUNT(*) as count
        FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND criadoEm > ${r}
      `;return t[0]?.count||0}}}},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{e.exports=require("node:fs")},74075:e=>{e.exports=require("zlib")},76760:e=>{e.exports=require("node:path")},77598:e=>{e.exports=require("node:crypto")},78474:e=>{e.exports=require("node:events")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},82598:(e,t,r)=>{r.d(t,{r:()=>s});var i=r(18318);class s{static validatePassword(e){let t=[];return(!e||e.length<9)&&t.push("Senha deve ter no m\xednimo 9 caracteres"),/[A-Z]/.test(e)||t.push("Senha deve conter pelo menos 1 letra mai\xfascula"),/[0-9]/.test(e)||t.push("Senha deve conter pelo menos 1 n\xfamero"),/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(e)||t.push("Senha deve conter pelo menos 1 s\xedmbolo especial"),{valid:0===t.length,errors:t}}static async hashPassword(e){return i.default.hash(e,12)}static async verifyPassword(e,t){return i.default.compare(e,t)}static generateProvisionalPassword(){let e="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789",t="!@#$%&*",r="";r+="ABCDEFGHJKLMNPQRSTUVWXYZ"[Math.floor(25*Math.random())],r+="23456789"[Math.floor(8*Math.random())],r+=t[Math.floor(Math.random()*t.length)];for(let t=0;t<6;t++)r+=e[Math.floor(Math.random()*e.length)];return r.split("").sort(()=>Math.random()-.5).join("")}static getPasswordStrength(e){let t=0,r=[];e.length>=9&&(t+=20,r.push("M\xednimo 9 caracteres")),/[A-Z]/.test(e)&&(t+=20,r.push("Letra mai\xfascula")),/[a-z]/.test(e)&&(t+=10,r.push("Letra min\xfascula")),/[0-9]/.test(e)&&(t+=20,r.push("N\xfamero")),/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(e)&&(t+=20,r.push("S\xedmbolo especial")),e.length>=12&&(t+=10,r.push("Senha longa (12+ caracteres)"));let i="Muito fraca",s="#ef4444";return t>=90?(i="Muito forte",s="#22c55e"):t>=70?(i="Forte",s="#84cc16"):t>=50?(i="Moderada",s="#eab308"):t>=30&&(i="Fraca",s="#f97316"),{score:t,label:i,color:s,criteriaMet:r}}}},83100:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>M,routeModule:()=>w,serverHooks:()=>R,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>A});var i={};r.r(i),r.d(i,{POST:()=>g});var s=r(96559),o=r(48088),a=r(37719),n=r(32190),d=r(13641),u=r(82598),c=r(53501),l=r(35508),p=r(90755),m=r(30776),h=r(69812);async function g(e){if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE)return n.NextResponse.json({error:"Service temporarily unavailable"},{status:503});let t=await p.Zb.isAllowed(e);if(!t.allowed)return n.NextResponse.json({error:t.message,retryAfter:Math.ceil((t.resetTime-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":"5","X-RateLimit-Remaining":t.remaining.toString(),"X-RateLimit-Reset":Math.ceil(t.resetTime/1e3).toString(),"Retry-After":Math.ceil((t.resetTime-Date.now())/1e3).toString()}});let i=e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||e.headers.get("cf-connecting-ip")||"unknown",s=e.headers.get("user-agent")||void 0;try{let t=await e.json().catch(()=>({})),o=h.X5.safeParse(t);if(!o.success)return n.NextResponse.json({error:"Email e senha s\xe3o obrigat\xf3rios"},{status:400});let{email:a,password:p}=o.data,g=(await d.z.$queryRaw`
      SELECT id, email, nomeCompleto, senha, senhaProvisoria, primeiroAcesso, status
      FROM Usuario 
      WHERE email = ${a}
      LIMIT 1
    `)[0];if(!g)return await l.BlockingService.recordFailedAttempt({email:a,ip:i,userAgent:s,motivo:"INVALID_EMAIL"}),n.NextResponse.json({error:"Credenciais inv\xe1lidas"},{status:401});if("ATIVO"!==g.status)return n.NextResponse.json({error:"Conta inativa. Entre em contato com o administrador."},{status:401});let w=await l.BlockingService.checkUserBlock(g.id);if(w.blocked){let e="Conta temporariamente bloqueada devido a m\xfaltiplas tentativas incorretas.";if(w.unlockAt){let t=Math.ceil((w.unlockAt.getTime()-Date.now())/6e4);e+=` Tente novamente em ${t} minuto(s).`}else e+=" Entre em contato com o administrador.";return n.NextResponse.json({error:e,blocked:!0,unlockAt:w.unlockAt,requiresPinUnlock:w.requiresPinUnlock,requiresSecurityQuestion:w.requiresSecurityQuestion},{status:423})}if(!await u.r.verifyPassword(p,g.senha))return await l.BlockingService.recordFailedAttempt({userId:g.id,email:a,ip:i,userAgent:s,motivo:"INVALID_PASSWORD"}),await m.g.logLogin(g.id,g.email,e,!1,{reason:"invalid_password"}),n.NextResponse.json({error:"Credenciais inv\xe1lidas"},{status:401});let x="LOGIN",A="mfa";if(g.primeiroAcesso&&(x="PRIMEIRO_ACESSO",A="primeiro-acesso",g.senhaProvisoria)){let e=await d.z.$queryRaw`
          SELECT (criadoEm < DATE_SUB(NOW(), INTERVAL 7 DAY)) as expired
          FROM Usuario 
          WHERE id = ${g.id}
        `;if(e[0]?.expired)return n.NextResponse.json({error:"Senha provis\xf3ria expirada",requiresPasswordReset:!0},{status:410})}let{code:R}=await c.q.createMFACode({usuarioId:g.id,tipoAcao:x,ip:i,userAgent:s}),{EmailService:M}=await Promise.all([r.e(9526),r.e(2849)]).then(r.bind(r,2849)),E=await M.sendMFA({to:g.email,userName:g.nomeCompleto,code:R,expiresInMinutes:5,isFirstAccess:g.primeiroAcesso});return E.success||console.error("[API] Erro ao enviar email MFA:",E.error),n.NextResponse.json({success:!0,mfaRequired:!0,nextStep:A,user:{id:g.id,email:g.email,nomeCompleto:g.nomeCompleto,primeiroAcesso:g.primeiroAcesso,senhaProvisoria:g.senhaProvisoria}},{status:200})}catch(e){try{console.error("[API] Login error:",e),e instanceof Error?console.error("[API] Login stack:",e.stack):console.error("[API] Login non-error object:",JSON.stringify(e,null,2))}catch(e){console.error("[API] Failed to log error in login handler:",e)}return n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:x,workUnitAsyncStorage:A,serverHooks:R}=w;function M(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:A})}},83997:e=>{e.exports=require("tty")},90755:(e,t,r)=>{r.d(t,{EQ:()=>c,Zb:()=>u});var i=r(32190),s=r(70300),o=r.n(s);let a=null;try{(a=new(o())({host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379"),lazyConnect:!0,connectTimeout:1e3,maxRetriesPerRequest:1})).on("error",()=>{let e=global;e.__redis_error_logged||(console.warn("[RATE LIMIT] Redis n\xe3o dispon\xedvel, usando rate limit em mem\xf3ria"),e.__redis_error_logged=!0)})}catch{console.warn("[RATE LIMIT] Redis n\xe3o dispon\xedvel, usando rate limit em mem\xf3ria"),a=null}let n=new Map;class d{constructor(e){this.options={keyGenerator:e=>this.getClientIP(e),skipSuccessfulRequests:!1,message:"Muitas tentativas. Tente novamente mais tarde.",...e}}getClientIP(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}async isAllowed(e,t){let r=t||this.options.keyGenerator(e),i=Date.now();try{if(!a)return this.checkMemoryLimit(r,i);{let e=i-this.options.windowMs;return await this.checkRedisLimit(r,i,e)}}catch(e){return console.error("[RATE LIMIT] Erro:",e),{allowed:!0,remaining:this.options.max,resetTime:i+this.options.windowMs}}}async checkRedisLimit(e,t,r){let i=`rate_limit:${e}`,s=a.pipeline();s.zremrangebyscore(i,"-inf",r),s.zcard(i),s.zadd(i,t,`${t}-${Math.random()}`),s.expire(i,Math.ceil(this.options.windowMs/1e3));let o=await s.exec();if(!o)throw Error("Redis pipeline failed");let n=o[1][1]||0,d=n<this.options.max;return{allowed:d,remaining:Math.max(0,this.options.max-n-1),resetTime:t+this.options.windowMs,message:d?void 0:this.options.message}}checkMemoryLimit(e,t){let r=n.get(e);r&&r.resetTime<=t&&n.delete(e);let i=n.get(e)||{count:0,resetTime:t+this.options.windowMs},s=i.count<this.options.max;return s&&(i.count++,n.set(e,i)),{allowed:s,remaining:Math.max(0,this.options.max-i.count),resetTime:i.resetTime,message:s?void 0:this.options.message}}middleware(){return async e=>{let t=await this.isAllowed(e);if(!t.allowed)return i.NextResponse.json({error:t.message,retryAfter:Math.ceil((t.resetTime-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":this.options.max.toString(),"X-RateLimit-Remaining":t.remaining.toString(),"X-RateLimit-Reset":Math.ceil(t.resetTime/1e3).toString(),"Retry-After":Math.ceil((t.resetTime-Date.now())/1e3).toString()}});let r=i.NextResponse.next();return r.headers.set("X-RateLimit-Limit",this.options.max.toString()),r.headers.set("X-RateLimit-Remaining",t.remaining.toString()),r.headers.set("X-RateLimit-Reset",Math.ceil(t.resetTime/1e3).toString()),r}}async checkLimit(e,t){return this.isAllowed(e,t)}}let u=new d({windowMs:9e5,max:5,message:"Muitas tentativas de login. Tente novamente em 15 minutos."}),c=new d({windowMs:3e5,max:3,keyGenerator:e=>{try{let t=e.body,r=t&&"object"==typeof t&&"email"in t?t.email:void 0;return r?`mfa:${r}`:`mfa:ip:${e.headers.get("x-forwarded-for")||"unknown"}`}catch{return`mfa:ip:${e.headers.get("x-forwarded-for")||"unknown"}`}},message:"Muitas tentativas de MFA. Aguarde 5 minutos."});new d({windowMs:36e5,max:3,message:"Muitas solicita\xe7\xf5es de reset. Tente novamente em 1 hora."}),new d({windowMs:6e4,max:100,message:"Muitas requisi\xe7\xf5es \xe0 API. Aguarde um momento."})},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[7719,580,9942,4501,8318,300,7378],()=>r(83100));module.exports=i})();