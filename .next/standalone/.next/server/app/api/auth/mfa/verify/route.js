(()=>{var e={};e.id=4193,e.ids=[2833,4193],e.modules={1708:e=>{"use strict";e.exports=require("node:process")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{"use strict";e.exports=require("node:tty")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},13641:(e,t,i)=>{"use strict";i.d(t,{z:()=>a.z});var a=i(31183)},14985:e=>{"use strict";e.exports=require("dns")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29979:(e,t,i)=>{"use strict";i.d(t,{I:()=>o});var a=i(13641);let r=null,s=0;async function o(){let e=Date.now();if(null!==r&&e-s<6e4)return r;try{let t=await a.z.$queryRaw`
      SELECT COUNT(*) AS cnt
      FROM INFORMATION_SCHEMA.COLUMNS
      WHERE TABLE_SCHEMA = DATABASE()
        AND TABLE_NAME = 'Usuario'
        AND COLUMN_NAME = 'tokenVersion'
    `;return r=(t?.[0]?.cnt??0)>0,s=e,r}catch{return r=!1,s=e,!1}}},31183:(e,t,i)=>{"use strict";i.d(t,{z:()=>r});var a=i(29942);let r=global.__prisma??new a.PrismaClient({log:["error"]})},31421:e=>{"use strict";e.exports=require("node:child_process")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{"use strict";e.exports=require("node:os")},48378:(e,t,i)=>{"use strict";i.d(t,{S:()=>d,z:()=>n});var a=i(87806),r=i(77412);let s=null;function o(){if(!s){let e="g5QZk5uXmGBy1267sLdrd8FHIzUqEtUrxnyJqoWYEqPklmXS1YiLp0ervYW7C017";if(e){if(e.length<32)throw Error("JWT_SECRET deve ter pelo menos 32 caracteres");s=new TextEncoder().encode(e)}else if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE||"phase-development-build"===process.env.NEXT_PHASE)console.warn("[JWT] Usando secret tempor\xe1rio durante build. Certifique-se de definir JWT_SECRET em produ\xe7\xe3o."),s=new TextEncoder().encode("temporary-build-secret-will-be-replaced-at-runtime-32-chars-minimum");else throw Error("Missing JWT_SECRET environment variable. Certifique-se de definir esta vari\xe1vel em .env.local")}return s}async function n(e,t="7d"){return await new a.P({role:e.role,status:e.status,tokenVersion:e.tokenVersion}).setProtectedHeader({alg:"HS256"}).setSubject(e.sub).setIssuer("gladpros").setAudience("gladpros-app").setExpirationTime(t).sign(o())}async function d(e){let{payload:t}=await (0,r.V)(e,o(),{issuer:"gladpros",audience:"gladpros-app"});return t}},51455:e=>{"use strict";e.exports=require("node:fs/promises")},53501:(e,t,i)=>{"use strict";i.d(t,{q:()=>o});var a=i(55511),r=i.n(a),s=i(13641);class o{static get delegate(){try{return s.z.codigoMFA}catch{return}}static generateCode(){return Math.floor(1e5+9e5*Math.random()).toString()}static hashCode(e){return r().createHash("sha256").update(e).digest("hex")}static async createMFACode({usuarioId:e,tipoAcao:t="LOGIN",ip:i,userAgent:a}){this.delegate?.deleteMany?await this.delegate.deleteMany({where:{usuarioId:e,tipoAcao:t,OR:[{usado:!0},{expiresAt:{lt:new Date}}]}}):await s.z.$executeRaw`
        DELETE FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND (usado = TRUE OR expiresAt < NOW())
      `;let r=this.generateCode(),o=this.hashCode(r),n=new Date(Date.now()+3e5);if(this.delegate?.create)return{code:r,id:(await this.delegate.create({data:{usuarioId:e,codigo:o,tipoAcao:t,expiresAt:n,usado:!1,ip:i,userAgent:a},select:{id:!0}})).id};{await s.z.$executeRaw`
        INSERT INTO CodigoMFA (usuarioId, codigo, tipoAcao, expiresAt, ip, userAgent)
        VALUES (${e}, ${o}, ${t}, ${n}, ${i}, ${a})
      `;let d=await s.z.$queryRaw`
        SELECT id FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND usado = FALSE
        ORDER BY criadoEm DESC
        LIMIT 1
      `;return{code:r,id:d[0]?.id||0}}}static async verifyMFACode({usuarioId:e,code:t,tipoAcao:i="LOGIN"}){let a=this.hashCode(t),r=this.delegate?.findFirst?await this.delegate.findFirst({where:{usuarioId:e,codigo:a,tipoAcao:i},orderBy:{criadoEm:"desc"},select:{id:!0,expiresAt:!0,usado:!0}}):(await s.z.$queryRaw`
          SELECT id, expiresAt, usado
          FROM CodigoMFA
          WHERE usuarioId = ${e}
          AND codigo = ${a}
          AND tipoAcao = ${i}
          ORDER BY criadoEm DESC
          LIMIT 1
        `)[0];return r?r.usado?{valid:!1,error:"C\xf3digo j\xe1 foi utilizado"}:new Date>r.expiresAt?{valid:!1,error:"C\xf3digo expirado"}:(this.delegate?.update?await this.delegate.update({where:{id:r.id},data:{usado:!0}}):await s.z.$executeRaw`
        UPDATE CodigoMFA SET usado = TRUE WHERE id = ${r.id}
      `,{valid:!0,codeId:r.id}):{valid:!1,error:"C\xf3digo inv\xe1lido"}}static async cleanupExpiredCodes(){return this.delegate?.deleteMany?(await this.delegate.deleteMany({where:{OR:[{usado:!0},{expiresAt:{lt:new Date}}]}})).count:Number(await s.z.$executeRaw`
        DELETE FROM CodigoMFA 
        WHERE expiresAt < NOW() OR usado = TRUE
      `)}static async countRecentAttempts(e,t=15){let i=new Date(Date.now()-60*t*1e3);if(this.delegate?.count)return await this.delegate.count({where:{usuarioId:e,criadoEm:{gt:i}}});{let t=await s.z.$queryRaw`
        SELECT COUNT(*) as count
        FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND criadoEm > ${i}
      `;return t[0]?.count||0}}}},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},69812:(e,t,i)=>{"use strict";i.d(t,{B0:()=>p,Dm:()=>w,E9:()=>h,KS:()=>g,PQ:()=>f,X5:()=>l,Zk:()=>v,cQ:()=>S,if:()=>x,rf:()=>m,tT:()=>E,yp:()=>A});var a=i(24501);let r=a.Yj().email("Email inv\xe1lido").max(255,"Email muito longo").toLowerCase().trim(),s=a.Yj().min(6,"Senha deve ter pelo menos 6 caracteres").max(128,"Senha muito longa").refine(e=>!!/[a-z]/.test(e)&&!!/[A-Z0-9]/.test(e),"Senha deve conter pelo menos: 1 letra min\xfascula e 1 mai\xfascula ou n\xfamero"),o=a.Yj().min(2,"Nome deve ter pelo menos 2 caracteres").max(100,"Nome muito longo").trim().refine(e=>/^[a-zA-ZÀ-ÿ\s]+$/.test(e),"Nome deve conter apenas letras e espa\xe7os"),n=a.Yj().length(4,"PIN deve ter exatamente 4 d\xedgitos").refine(e=>/^\d{4}$/.test(e),"PIN deve conter apenas n\xfameros"),d=a.Yj().length(6,"C\xf3digo MFA deve ter exatamente 6 d\xedgitos").refine(e=>/^\d{6}$/.test(e),"C\xf3digo MFA deve conter apenas n\xfameros"),u=a.Yj().min(5,"Pergunta de seguran\xe7a muito curta").max(200,"Pergunta de seguran\xe7a muito longa").trim(),c=a.Yj().min(2,"Resposta muito curta").max(100,"Resposta muito longa").trim().toLowerCase(),l=a.Ik({email:r,password:a.Yj().min(1,"Senha \xe9 obrigat\xf3ria")}),m=a.Ik({userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),code:d,tipoAcao:a.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD"]).optional()}),p=a.Ik({email:r});a.Ik({userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),novaSenha:s,pin:n,perguntaSeguranca:u,respostaSeguranca:c});let E=a.Ik({userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),newPassword:s,pin:n,securityQuestion:u,securityAnswer:c});a.Ik({token:a.Yj().min(1,"Token \xe9 obrigat\xf3rio"),novaSenha:s});let g=a.Ik({token:a.Yj().min(1,"Token \xe9 obrigat\xf3rio"),senha:s}),h=a.Ik({email:r}),w=a.Ik({email:r});a.Ik({nomeCompleto:o,email:r,tipo:a.k5(["ADMIN","USUARIO","CLIENTE"]),departamento:a.Yj().max(100,"Departamento muito longo").optional(),cargo:a.Yj().max(100,"Cargo muito longo").optional()}),a.Ik({nomeCompleto:o.optional(),email:r.optional(),tipo:a.k5(["ADMIN","USUARIO","CLIENTE"]).optional(),departamento:a.Yj().max(100,"Departamento muito longo").optional(),cargo:a.Yj().max(100,"Cargo muito longo").optional(),status:a.k5(["ATIVO","INATIVO","SUSPENSO"]).optional()}).refine(e=>Object.keys(e).length>0,"Pelo menos um campo deve ser fornecido para atualiza\xe7\xe3o");let A=a.gM("method",[a.Ik({method:a.eu("pin"),userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),pin:n}),a.Ik({method:a.eu("security"),userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),answer:c})]),v=a.Ik({userId:a.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),tipoAcao:a.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD","RESET","DESBLOQUEIO"]).optional()}),R=a.Ik({nomeCompleto:a.Yj().optional(),email:r,role:a.Yj().optional(),ativo:a.zM().optional(),criadoEm:a.KC([a.Yj(),a.ai(),a.p6()]).optional()}),x=a.Ik({filename:a.Yj().min(1).max(128).optional(),users:a.YO(R).min(1)}),S=a.Ik({email:r.optional(),nomeCompleto:o.optional(),role:a.k5(["ADMIN","GERENTE","USUARIO","FINANCEIRO","ESTOQUE","CLIENTE"]).optional(),status:a.k5(["ATIVO","INATIVO"]).optional(),telefone:a.Yj().max(32).optional().or(a.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=10&&t.length<=11},"Telefone deve ter entre 10 e 11 d\xedgitos. Exemplo: (11)99999-9999"),dataNascimento:a.KC([a.Yj(),a.p6()]).optional().transform(e=>{if(!e)return;if(e instanceof Date){if(isNaN(e.getTime()))return;let t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${a}`}let t=String(e).trim();if(t.match(/^(\d{4})-(\d{2})-(\d{2})$/))return t;let i=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(i){let[,e,t,a]=i,r=parseInt(t,10),s=parseInt(e,10);if(s<1||s>12||r<1||r>31)return"INVALID_DATE";let o=t.padStart(2,"0"),n=e.padStart(2,"0");return`${a}-${n}-${o}`}return"INVALID_DATE"}).refine(e=>!e||"INVALID_DATE"!==e&&!isNaN(new Date(e+"T00:00:00.000Z").getTime()),"Data de nascimento inv\xe1lida. Use o formato MM/DD/YYYY (ex: 05/18/1979)"),endereco1:a.Yj().max(191).optional().or(a.eu("")).transform(e=>e||void 0),endereco2:a.Yj().max(191).optional().or(a.eu("")).transform(e=>e||void 0),cidade:a.Yj().max(96).optional().or(a.eu("")).transform(e=>e||void 0),estado:a.Yj().max(32).optional().or(a.eu("")).transform(e=>e||void 0),cep:a.Yj().max(16).optional().or(a.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=5&&t.length<=9&&t===e.replace(/\D/g,"")},"CEP deve conter apenas n\xfameros. Exemplo: 01234567"),anotacoes:a.Yj().optional().or(a.eu("")).transform(e=>e&&e.trim().length>0?e:void 0)}),f=a.Ik({ativo:a.zM()})},73024:e=>{"use strict";e.exports=require("node:fs")},76760:e=>{"use strict";e.exports=require("node:path")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80264:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>R,routeModule:()=>h,serverHooks:()=>v,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>A});var a={};i.r(a),i.d(a,{POST:()=>g});var r=i(96559),s=i(48088),o=i(37719),n=i(32190),d=i(13641),u=i(29979),c=i(53501),l=i(48378),m=i(90755),p=i(69812),E=i(92833);async function g(e){if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE)return new Response(JSON.stringify({error:"Service unavailable during build",message:"This endpoint is not available during the build process"}),{status:503,headers:{"Content-Type":"application/json"}});try{let t,a=await e.json().catch(()=>({})),r=p.rf.safeParse(a);if(!r.success)return n.NextResponse.json({error:"ID do usu\xe1rio e c\xf3digo s\xe3o obrigat\xf3rios"},{status:400});let{userId:s,code:o,tipoAcao:g="LOGIN"}=r.data,h=await d.z.$queryRaw`
      SELECT email FROM Usuario WHERE id = ${s} LIMIT 1
    `,w=h[0]?.email;if(!w)return n.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado"},{status:404});let A=await m.EQ.checkLimit(e,`mfa:${w}`);if(!A.allowed)return n.NextResponse.json({error:A.message,retryAfter:Math.ceil((A.resetTime-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":"3","X-RateLimit-Remaining":A.remaining.toString(),"Retry-After":Math.ceil((A.resetTime-Date.now())/1e3).toString()}});let v=await c.q.verifyMFACode({usuarioId:s,code:o,tipoAcao:"RESET_PASSWORD"===g?"RESET":g});if(!v.valid)return n.NextResponse.json({error:v.error||"C\xf3digo inv\xe1lido"},{status:401});let R=[];if(await (0,u.I)())try{R=await d.z.$queryRaw`
          SELECT id, email, nomeCompleto, primeiroAcesso, senhaProvisoria, nivel as tipo, tokenVersion
          FROM Usuario 
          WHERE id = ${s}
          LIMIT 1
        `}catch{}0===R.length&&(R=(await d.z.$queryRaw`
        SELECT id, email, nomeCompleto, primeiroAcesso, senhaProvisoria, nivel as tipo
        FROM Usuario
        WHERE id = ${s}
        LIMIT 1
      `).map(e=>({...e,tokenVersion:0})));let x=R[0];if(!x)return n.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado"},{status:404});let S=(x.tipo||"USUARIO").toUpperCase(),f=await (0,l.z)({sub:x.id.toString(),role:S,status:"ATIVO",tokenVersion:x.tokenVersion??0},"24h"),T=e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||e.headers.get("cf-connecting-ip")||"unknown",I=e.headers.get("user-agent")||void 0;await d.z.$executeRaw`
      INSERT INTO TentativaLogin (usuarioId, email, sucesso, ip, userAgent)
      VALUES (${x.id}, ${x.email}, TRUE, ${T}, ${I})
    `,await d.z.$executeRaw`
      UPDATE Usuario 
      SET ultimoLoginEm = NOW() 
      WHERE id = ${x.id}
    `;try{let{BlockingService:e}=await i.e(5508).then(i.bind(i,35508));await e.clearFailedAttempts(x.id)}catch(e){console.warn("[MFA] Falha ao desbloquear usu\xe1rio ap\xf3s sucesso:",e)}if(x.primeiroAcesso){let e=n.NextResponse.json({success:!0,requiresSetup:!0,nextStep:"primeiro-acesso",redirectUrl:`/primeiro-acesso?userId=${x.id}`,user:{id:x.id,email:x.email,nomeCompleto:x.nomeCompleto,primeiroAcesso:x.primeiroAcesso,senhaProvisoria:x.senhaProvisoria}});return e.cookies.set("authToken",f,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:86400}),e}try{t=await E.SecurityService.createSession(x.id,T,I)}catch(e){console.warn("[MFA] Falha ao criar sess\xe3o ativa:",e)}let y=n.NextResponse.json({success:!0,user:{id:x.id,email:x.email,nomeCompleto:x.nomeCompleto,tipo:x.tipo},token:f});return y.cookies.set("authToken",f,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:86400}),t&&y.cookies.set("sessionToken",t,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:86400}),y}catch(e){return console.error("[API] MFA Verify error:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/auth/mfa/verify/route",pathname:"/api/auth/mfa/verify",filename:"route",bundlePath:"app/api/auth/mfa/verify/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\auth\\mfa\\verify\\route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:w,workUnitAsyncStorage:A,serverHooks:v}=h;function R(){return(0,o.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:A})}},83997:e=>{"use strict";e.exports=require("tty")},90755:(e,t,i)=>{"use strict";i.d(t,{EQ:()=>c,Zb:()=>u});var a=i(32190),r=i(70300),s=i.n(r);let o=null;try{(o=new(s())({host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379"),lazyConnect:!0,connectTimeout:1e3,maxRetriesPerRequest:1})).on("error",()=>{let e=global;e.__redis_error_logged||(console.warn("[RATE LIMIT] Redis n\xe3o dispon\xedvel, usando rate limit em mem\xf3ria"),e.__redis_error_logged=!0)})}catch{console.warn("[RATE LIMIT] Redis n\xe3o dispon\xedvel, usando rate limit em mem\xf3ria"),o=null}let n=new Map;class d{constructor(e){this.options={keyGenerator:e=>this.getClientIP(e),skipSuccessfulRequests:!1,message:"Muitas tentativas. Tente novamente mais tarde.",...e}}getClientIP(e){let t=e.headers.get("x-forwarded-for"),i=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():i||"unknown"}async isAllowed(e,t){let i=t||this.options.keyGenerator(e),a=Date.now();try{if(!o)return this.checkMemoryLimit(i,a);{let e=a-this.options.windowMs;return await this.checkRedisLimit(i,a,e)}}catch(e){return console.error("[RATE LIMIT] Erro:",e),{allowed:!0,remaining:this.options.max,resetTime:a+this.options.windowMs}}}async checkRedisLimit(e,t,i){let a=`rate_limit:${e}`,r=o.pipeline();r.zremrangebyscore(a,"-inf",i),r.zcard(a),r.zadd(a,t,`${t}-${Math.random()}`),r.expire(a,Math.ceil(this.options.windowMs/1e3));let s=await r.exec();if(!s)throw Error("Redis pipeline failed");let n=s[1][1]||0,d=n<this.options.max;return{allowed:d,remaining:Math.max(0,this.options.max-n-1),resetTime:t+this.options.windowMs,message:d?void 0:this.options.message}}checkMemoryLimit(e,t){let i=n.get(e);i&&i.resetTime<=t&&n.delete(e);let a=n.get(e)||{count:0,resetTime:t+this.options.windowMs},r=a.count<this.options.max;return r&&(a.count++,n.set(e,a)),{allowed:r,remaining:Math.max(0,this.options.max-a.count),resetTime:a.resetTime,message:r?void 0:this.options.message}}middleware(){return async e=>{let t=await this.isAllowed(e);if(!t.allowed)return a.NextResponse.json({error:t.message,retryAfter:Math.ceil((t.resetTime-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":this.options.max.toString(),"X-RateLimit-Remaining":t.remaining.toString(),"X-RateLimit-Reset":Math.ceil(t.resetTime/1e3).toString(),"Retry-After":Math.ceil((t.resetTime-Date.now())/1e3).toString()}});let i=a.NextResponse.next();return i.headers.set("X-RateLimit-Limit",this.options.max.toString()),i.headers.set("X-RateLimit-Remaining",t.remaining.toString()),i.headers.set("X-RateLimit-Reset",Math.ceil(t.resetTime/1e3).toString()),i}}async checkLimit(e,t){return this.isAllowed(e,t)}}let u=new d({windowMs:9e5,max:5,message:"Muitas tentativas de login. Tente novamente em 15 minutos."}),c=new d({windowMs:3e5,max:3,keyGenerator:e=>{try{let t=e.body,i=t&&"object"==typeof t&&"email"in t?t.email:void 0;return i?`mfa:${i}`:`mfa:ip:${e.headers.get("x-forwarded-for")||"unknown"}`}catch{return`mfa:ip:${e.headers.get("x-forwarded-for")||"unknown"}`}},message:"Muitas tentativas de MFA. Aguarde 5 minutos."});new d({windowMs:36e5,max:3,message:"Muitas solicita\xe7\xf5es de reset. Tente novamente em 1 hora."}),new d({windowMs:6e4,max:100,message:"Muitas requisi\xe7\xf5es \xe0 API. Aguarde um momento."})},91645:e=>{"use strict";e.exports=require("net")},92833:(e,t,i)=>{"use strict";i.d(t,{SecurityService:()=>u});var a=i(13641),r=i(18318),s=i(55511),o=i.n(s);function n(){return a.z.historicoSenha}function d(){return a.z.tentativaLogin}class u{static async createSession(e,t,i){let r=o().randomBytes(32).toString("hex");try{await this.cleanExpiredSessions()}catch{}try{await this.revokeAllUserSessions(e)}catch{}let s=a.z.sessaoAtiva;return s?.create?await s.create({data:{usuarioId:e,token:r,ip:t||null,userAgent:i||null}}):await a.z.$executeRaw`
        INSERT INTO SessaoAtiva (usuarioId, token, ip, userAgent, ultimaAtividade, criadoEm)
        VALUES (${e}, ${r}, ${t||null}, ${i||null}, NOW(), NOW())
      `,r}static async updateSessionActivity(e){let t=a.z.sessaoAtiva;if(t?.update)return void await t.update({where:{token:e},data:{ultimaAtividade:new Date}}).catch(()=>{});await a.z.$executeRaw`
      UPDATE SessaoAtiva SET ultimaAtividade = NOW() WHERE token = ${e}
    `}static async getUserSessions(e){let t,i=a.z.sessaoAtiva;return(i?.findMany?await i.findMany({where:{usuarioId:e},orderBy:{ultimaAtividade:"desc"}}):await a.z.$queryRaw`
        SELECT id, usuarioId, token, ip, userAgent, cidade, pais, ultimaAtividade, criadoEm
        FROM SessaoAtiva
        WHERE usuarioId = ${e}
        ORDER BY ultimaAtividade DESC
      `).map(e=>({id:e.id,token:e.token,ip:e.ip||void 0,userAgent:e.userAgent||void 0,cidade:e.cidade||void 0,pais:e.pais||void 0,ultimaAtividade:e.ultimaAtividade,criadoEm:e.criadoEm}))}static async revokeSession(e){let t=a.z.sessaoAtiva;if(t?.delete)return void await t.delete({where:{id:e}}).catch(()=>{});await a.z.$executeRaw`
      DELETE FROM SessaoAtiva WHERE id = ${e}
    `}static async revokeSessionByToken(e){let t=a.z.sessaoAtiva;if(t?.deleteMany)return void await t.deleteMany({where:{token:e}});await a.z.$executeRaw`
      DELETE FROM SessaoAtiva WHERE token = ${e}
    `}static async revokeAllUserSessions(e){let t=a.z.sessaoAtiva;if(t?.deleteMany)return void await t.deleteMany({where:{usuarioId:e}});await a.z.$executeRaw`
      DELETE FROM SessaoAtiva WHERE usuarioId = ${e}
    `}static async cleanExpiredSessions(){let e=new Date(Date.now()-864e5),t=a.z.sessaoAtiva;if(t?.deleteMany)return void await t.deleteMany({where:{ultimaAtividade:{lt:e}}});await a.z.$executeRaw`
      DELETE FROM SessaoAtiva WHERE ultimaAtividade < ${e}
    `}static async addPasswordToHistory(e,t){await n().create({data:{usuarioId:e,senhaHash:t}});let i=await n().findMany({where:{usuarioId:e},orderBy:{criadaEm:"desc"},skip:5,select:{id:!0}});i.length>0&&await n().deleteMany({where:{id:{in:i.map(e=>e.id)}}})}static async isPasswordReused(e,t){for(let i of(await n().findMany({where:{usuarioId:e},orderBy:{criadaEm:"desc"},take:5,select:{senhaHash:!0}})))if(await r.default.compare(t,i.senhaHash))return!0;return!1}static async getLoginAttempts(e=100){return(await d().findMany({orderBy:{criadaEm:"desc"},take:e,select:{id:!0,email:!0,ip:!0,userAgent:!0,sucesso:!0,criadaEm:!0}})).map(e=>({id:e.id,email:e.email,ip:e.ip||void 0,userAgent:e.userAgent||void 0,sucesso:e.sucesso,criadoEm:e.criadaEm}))}static async getFailedLogins(e=24){let t=new Date(Date.now()-60*e*6e4);return(await d().findMany({where:{sucesso:!1,criadaEm:{gt:t}},orderBy:{criadaEm:"desc"},select:{id:!0,email:!0,ip:!0,userAgent:!0,sucesso:!0,criadaEm:!0}})).map(e=>({id:e.id,email:e.email,ip:e.ip||void 0,userAgent:e.userAgent||void 0,sucesso:e.sucesso,criadoEm:e.criadaEm}))}static async getLoginAttemptsByUser(e,t=100){return(await a.z.$queryRaw`
      SELECT id, email, ip, userAgent, sucesso, motivo, criadaEm
      FROM TentativaLogin
      WHERE usuarioId = ${e}
      ORDER BY criadaEm DESC
      LIMIT ${t}
    `).map(e=>({id:e.id,email:e.email,ip:e.ip||void 0,userAgent:e.userAgent||void 0,sucesso:e.sucesso,motivoFalha:e.motivo||void 0,criadoEm:e.criadaEm}))}static async getActiveSessions(){return(await a.z.sessaoAtiva.findMany({include:{usuario:{select:{nomeCompleto:!0,email:!0}}},orderBy:{ultimaAtividade:"desc"}})).map(e=>({id:e.id,token:e.token,ip:e.ip||void 0,userAgent:e.userAgent||void 0,cidade:e.cidade||void 0,pais:e.pais||void 0,ultimaAtividade:e.ultimaAtividade,criadoEm:e.criadoEm}))}}},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[7719,580,9942,4501,4553,8318,300],()=>i(80264));module.exports=a})();