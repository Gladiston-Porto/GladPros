(()=>{var e={};e.id=9917,e.ids=[3603,9917],e.modules={1708:e=>{"use strict";e.exports=require("node:process")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{"use strict";e.exports=require("node:tty")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13641:(e,t,a)=>{"use strict";a.d(t,{z:()=>o.z});var o=a(31183)},16698:e=>{"use strict";e.exports=require("node:async_hooks")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31183:(e,t,a)=>{"use strict";a.d(t,{z:()=>r});var o=a(29942);let r=global.__prisma??new o.PrismaClient({log:["error"]})},31421:e=>{"use strict";e.exports=require("node:child_process")},33873:e=>{"use strict";e.exports=require("path")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{"use strict";e.exports=require("node:os")},51455:e=>{"use strict";e.exports=require("node:fs/promises")},55511:e=>{"use strict";e.exports=require("crypto")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},69812:(e,t,a)=>{"use strict";a.d(t,{B0:()=>m,Dm:()=>f,E9:()=>I,KS:()=>g,PQ:()=>S,X5:()=>p,Zk:()=>R,cQ:()=>x,if:()=>v,rf:()=>c,tT:()=>E,yp:()=>N});var o=a(24501);let r=o.Yj().email("Email inv\xe1lido").max(255,"Email muito longo").toLowerCase().trim(),i=o.Yj().min(6,"Senha deve ter pelo menos 6 caracteres").max(128,"Senha muito longa").refine(e=>!!/[a-z]/.test(e)&&!!/[A-Z0-9]/.test(e),"Senha deve conter pelo menos: 1 letra min\xfascula e 1 mai\xfascula ou n\xfamero"),s=o.Yj().min(2,"Nome deve ter pelo menos 2 caracteres").max(100,"Nome muito longo").trim().refine(e=>/^[a-zA-ZÀ-ÿ\s]+$/.test(e),"Nome deve conter apenas letras e espa\xe7os"),n=o.Yj().length(4,"PIN deve ter exatamente 4 d\xedgitos").refine(e=>/^\d{4}$/.test(e),"PIN deve conter apenas n\xfameros"),u=o.Yj().length(6,"C\xf3digo MFA deve ter exatamente 6 d\xedgitos").refine(e=>/^\d{6}$/.test(e),"C\xf3digo MFA deve conter apenas n\xfameros"),l=o.Yj().min(5,"Pergunta de seguran\xe7a muito curta").max(200,"Pergunta de seguran\xe7a muito longa").trim(),d=o.Yj().min(2,"Resposta muito curta").max(100,"Resposta muito longa").trim().toLowerCase(),p=o.Ik({email:r,password:o.Yj().min(1,"Senha \xe9 obrigat\xf3ria")}),c=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),code:u,tipoAcao:o.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD"]).optional()}),m=o.Ik({email:r});o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),novaSenha:i,pin:n,perguntaSeguranca:l,respostaSeguranca:d});let E=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),newPassword:i,pin:n,securityQuestion:l,securityAnswer:d});o.Ik({token:o.Yj().min(1,"Token \xe9 obrigat\xf3rio"),novaSenha:i});let g=o.Ik({token:o.Yj().min(1,"Token \xe9 obrigat\xf3rio"),senha:i}),I=o.Ik({email:r}),f=o.Ik({email:r});o.Ik({nomeCompleto:s,email:r,tipo:o.k5(["ADMIN","USUARIO","CLIENTE"]),departamento:o.Yj().max(100,"Departamento muito longo").optional(),cargo:o.Yj().max(100,"Cargo muito longo").optional()}),o.Ik({nomeCompleto:s.optional(),email:r.optional(),tipo:o.k5(["ADMIN","USUARIO","CLIENTE"]).optional(),departamento:o.Yj().max(100,"Departamento muito longo").optional(),cargo:o.Yj().max(100,"Cargo muito longo").optional(),status:o.k5(["ATIVO","INATIVO","SUSPENSO"]).optional()}).refine(e=>Object.keys(e).length>0,"Pelo menos um campo deve ser fornecido para atualiza\xe7\xe3o");let N=o.gM("method",[o.Ik({method:o.eu("pin"),userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),pin:n}),o.Ik({method:o.eu("security"),userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),answer:d})]),R=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),tipoAcao:o.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD","RESET","DESBLOQUEIO"]).optional()}),h=o.Ik({nomeCompleto:o.Yj().optional(),email:r,role:o.Yj().optional(),ativo:o.zM().optional(),criadoEm:o.KC([o.Yj(),o.ai(),o.p6()]).optional()}),v=o.Ik({filename:o.Yj().min(1).max(128).optional(),users:o.YO(h).min(1)}),x=o.Ik({email:r.optional(),nomeCompleto:s.optional(),role:o.k5(["ADMIN","GERENTE","USUARIO","FINANCEIRO","ESTOQUE","CLIENTE"]).optional(),status:o.k5(["ATIVO","INATIVO"]).optional(),telefone:o.Yj().max(32).optional().or(o.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=10&&t.length<=11},"Telefone deve ter entre 10 e 11 d\xedgitos. Exemplo: (11)99999-9999"),dataNascimento:o.KC([o.Yj(),o.p6()]).optional().transform(e=>{if(!e)return;if(e instanceof Date){if(isNaN(e.getTime()))return;let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${o}`}let t=String(e).trim();if(t.match(/^(\d{4})-(\d{2})-(\d{2})$/))return t;let a=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(a){let[,e,t,o]=a,r=parseInt(t,10),i=parseInt(e,10);if(i<1||i>12||r<1||r>31)return"INVALID_DATE";let s=t.padStart(2,"0"),n=e.padStart(2,"0");return`${o}-${n}-${s}`}return"INVALID_DATE"}).refine(e=>!e||"INVALID_DATE"!==e&&!isNaN(new Date(e+"T00:00:00.000Z").getTime()),"Data de nascimento inv\xe1lida. Use o formato MM/DD/YYYY (ex: 05/18/1979)"),endereco1:o.Yj().max(191).optional().or(o.eu("")).transform(e=>e||void 0),endereco2:o.Yj().max(191).optional().or(o.eu("")).transform(e=>e||void 0),cidade:o.Yj().max(96).optional().or(o.eu("")).transform(e=>e||void 0),estado:o.Yj().max(32).optional().or(o.eu("")).transform(e=>e||void 0),cep:o.Yj().max(16).optional().or(o.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=5&&t.length<=9&&t===e.replace(/\D/g,"")},"CEP deve conter apenas n\xfameros. Exemplo: 01234567"),anotacoes:o.Yj().optional().or(o.eu("")).transform(e=>e&&e.trim().length>0?e:void 0)}),S=o.Ik({ativo:o.zM()})},73024:e=>{"use strict";e.exports=require("node:fs")},73603:(e,t,a)=>{"use strict";a.d(t,{AuditoriaService:()=>r});var o=a(13641);class r{static async registrar({tabela:e,registroId:t,acao:a,usuarioId:r,ip:i,payload:s}){try{await o.z.$executeRaw`
        INSERT INTO Auditoria (tabela, registroId, acao, usuarioId, ip, payload)
        VALUES (${e}, ${t}, ${a}, ${r}, ${i}, ${JSON.stringify(s)})
      `}catch(e){console.error("Erro ao registrar auditoria:",e)}}static async registrarLogin(e,t,a){await this.registrar({tabela:"Usuario",registroId:e,acao:"LOGIN",usuarioId:e,ip:t,payload:{userAgent:a,timestamp:new Date().toISOString()}})}static async registrarLogout(e,t,a){await this.registrar({tabela:"Usuario",registroId:e,acao:"LOGOUT",usuarioId:e,ip:t,payload:{duration:a,timestamp:new Date().toISOString()}})}static async registrarCriacaoUsuario(e,t,a,o){await this.registrar({tabela:"Usuario",registroId:e,acao:"CREATE",usuarioId:a,ip:o,payload:t})}static async registrarAtualizacaoUsuario(e,t,a,o,r){await this.registrar({tabela:"Usuario",registroId:e,acao:"UPDATE",usuarioId:o,ip:r,payload:{before:t,after:a}})}static async registrarExclusaoUsuario(e,t,a,o){await this.registrar({tabela:"Usuario",registroId:e,acao:"DELETE",usuarioId:a,ip:o,payload:t})}static async buscarPorUsuario(e,t=100){return await o.z.$queryRaw`
      SELECT 
        a.id,
        a.tabela,
        a.registroId,
        a.acao,
        a.usuarioId,
        a.ip,
        a.payload,
        a.criadoEm,
        u.nomeCompleto,
        u.email
      FROM Auditoria a
      LEFT JOIN Usuario u ON a.usuarioId = u.id
      WHERE a.registroId = ${e} AND a.tabela = 'Usuario'
         OR a.usuarioId = ${e}
      ORDER BY a.criadoEm DESC
      LIMIT ${t}
    `}static async buscarPorTabela(e,t){return await o.z.$queryRaw`
      SELECT 
        a.id,
        a.tabela,
        a.registroId,
        a.acao,
        a.usuarioId,
        a.ip,
        a.payload,
        a.criadoEm,
        u.nomeCompleto,
        u.email
      FROM Auditoria a
      LEFT JOIN Usuario u ON a.usuarioId = u.id
      WHERE a.tabela = ${e} AND a.registroId = ${t}
      ORDER BY a.criadoEm DESC
    `}}},76760:e=>{"use strict";e.exports=require("node:path")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},91540:(e,t,a)=>{"use strict";a.r(t),a.d(t,{patchFetch:()=>x,routeModule:()=>N,serverHooks:()=>v,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>h});var o={};a.r(o),a.d(o,{DELETE:()=>f,GET:()=>E,PATCH:()=>g,PUT:()=>I});var r=a(96559),i=a(48088),s=a(37719),n=a(32190),u=a(13641),l=a(18318),d=a(73603),p=a(69812);async function c(e){let t=e?.params??e;return("function"==typeof t?.then?await t:t)??{}}async function m(e,t=2,a=500){let o;for(let r=0;r<=t;r++)try{return await e()}catch(i){let e=i?.code||i?.errorCode;if("PrismaClientInitializationError"!==i?.name&&"P1001"!==e||r===t)throw i;o=i,await new Promise(e=>setTimeout(e,a))}throw o}async function E(e,t){if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE)return n.NextResponse.json({error:"Service temporarily unavailable"},{status:503});try{let e=await c(t),a=e?.id,o=Number(a);if(!o)return n.NextResponse.json({code:"INVALID_ID"},{status:400});let r=(await m(()=>u.z.$queryRaw`SELECT * FROM Usuario WHERE id = ${o} LIMIT 1`))[0];if(!r)return n.NextResponse.json({code:"NOT_FOUND"},{status:404});let i=null,s=r.dataNascimento??r.nascimento??r.data_nascimento??r.birthdate??r.dob??null;if(s instanceof Date){let e=s.getUTCFullYear(),t=String(s.getUTCMonth()+1).padStart(2,"0"),a=String(s.getUTCDate()).padStart(2,"0");i=`${t}/${a}/${e}`}else if("string"==typeof s){let e=s.slice(0,10).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(e){let[,t,a,o]=e;i=`${a}/${o}/${t}`}}let l=r.nomeCompleto??r.nome??r?.nome_completo??r?.full_name??null,d={id:r.id,email:r.email,nomeCompleto:l&&String(l).trim().length>0?String(l):r.email,role:r.role??r.nivel??null,status:r.status??null,telefone:r.telefone??r.celular??r.telefone1??r.phone??null,dataNascimento:i,endereco1:r.endereco1??null,endereco2:r.endereco2??null,cidade:r.cidade??null,estado:r.estado??null,cep:r.zipcode??r.cep??null,anotacoes:r.anotacoes??null,ultimoLoginEm:r.ultimoLoginEm??null,criadoEm:r.criadoEm??null,atualizadoEm:r.atualizadoEm??null,avatarUrl:r.avatarUrl??null};return n.NextResponse.json(d,{status:200})}catch(e){return console.error("GET /api/usuarios/[id] error:",e),n.NextResponse.json({error:"INTERNAL_ERROR"},{status:500})}}async function g(e,t){try{let a=await c(t),o=a?.id,r=Number(o);if(!r)return n.NextResponse.json({code:"INVALID_ID"},{status:400});let i=await e.json().catch(()=>({})),s=p.cQ.safeParse(i);if(!s.success){let e=s.error.issues,t={};for(let a of e)t[a.path[0]||"general"]=a.message;return n.NextResponse.json({error:"VALIDATION_ERROR",message:"Dados inv\xe1lidos. Verifique os campos.",fields:t},{status:400})}let E=s.data,g=await u.z.$queryRaw`
      SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'Usuario'
  `,I=new Set(g.map(e=>String(e.COLUMN_NAME))),f=[],N=[];for(let e of["email","nomeCompleto","telefone","dataNascimento","endereco1","endereco2","cidade","estado","zipcode","cep","role","nivel","status","senha","avatarUrl","anotacoes"]){let t=E[e];if(Object.prototype.hasOwnProperty.call(E,e)&&null!=t){if("string"==typeof t&&""===t.trim())continue;if("senha"===e){let e=await l.default.hash(String(t),10);f.push("senha = ?"),N.push(e)}else if("cep"!==e||E.zipcode)if("nomeCompleto"===e){let e=I.has("nomeCompleto")?"nomeCompleto":I.has("nome")?"nome":null;e&&(f.push(`${e} = ?`),N.push(String(t)))}else if("dataNascimento"===e){let e=String(t).trim(),a=null,o=e.match(/^(\d{4})-(\d{2})-(\d{2})$/),r=e.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(o)a=e;else if(r){let[,e,t,o]=r;a=`${o}-${e}-${t}`}let i=I.has("dataNascimento")?"dataNascimento":I.has("nascimento")?"nascimento":I.has("data_nascimento")?"data_nascimento":I.has("dob")?"dob":null;i&&(f.push(`${i} = ?`),N.push(a))}else{let a=e;if(("nivel"===e||"role"===e)&&(a=I.has("nivel")?"nivel":I.has("role")?"role":e),"zipcode"===e&&(a=I.has("zipcode")?"zipcode":I.has("cep")?"cep":e),I.has(a)){let e="telefone"===a&&"string"==typeof t?String(t).replace(/\D/g,""):t;f.push(`${a} = ?`),N.push(e)}}else{let e=I.has("zipcode")?"zipcode":I.has("cep")?"cep":null;e&&(f.push(`${e} = ?`),N.push(String(t)))}}}if(0===f.length)return n.NextResponse.json({ok:!0,message:"NO_CHANGES"});let R=(await m(()=>u.z.$queryRaw`SELECT * FROM Usuario WHERE id = ${r} LIMIT 1`))[0],h=`UPDATE Usuario SET ${f.join(", ")}, atualizadoEm = NOW() WHERE id = ?`;N.push(r),await m(()=>u.z.$executeRawUnsafe(h,...N));let v=(await m(()=>u.z.$queryRaw`SELECT * FROM Usuario WHERE id = ${r} LIMIT 1`))[0];try{let t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";await d.AuditoriaService.registrarAtualizacaoUsuario(r,R,v,void 0,t)}catch(e){console.error("Erro ao registrar auditoria:",e)}return n.NextResponse.json({ok:!0})}catch(t){console.error("PATCH /api/usuarios/[id] error:",t);let e=t?.message||String(t);if("P2010"===t?.code&&e.includes("Incorrect date value"))return n.NextResponse.json({error:"VALIDATION_ERROR",message:"Data de nascimento inv\xe1lida. Use o formato MM/DD/YYYY (exemplo: 05/18/1979)",fields:{dataNascimento:"Data de nascimento inv\xe1lida. Use o formato MM/DD/YYYY (exemplo: 05/18/1979)"}},{status:400});if(e.toLowerCase().includes("telefone"))return n.NextResponse.json({error:"VALIDATION_ERROR",message:"Telefone inv\xe1lido. Deve ter entre 10 e 11 d\xedgitos.",fields:{telefone:"Telefone deve ter entre 10 e 11 d\xedgitos. Exemplo: (11)99999-9999"}},{status:400});if(e.toLowerCase().includes("cep"))return n.NextResponse.json({error:"VALIDATION_ERROR",message:"CEP inv\xe1lido. Deve conter apenas n\xfameros.",fields:{cep:"CEP deve conter apenas n\xfameros. Exemplo: 01234567"}},{status:400});return n.NextResponse.json({error:"INTERNAL_ERROR",message:"Erro interno do servidor. Verifique os dados e tente novamente."},{status:500})}}async function I(e,t){return g(e,t)}async function f(e,t){try{let e=await c(t),a=e?.id,o=Number(a);if(!o)return n.NextResponse.json({code:"INVALID_ID"},{status:400});return await m(()=>u.z.$executeRawUnsafe("DELETE FROM Usuario WHERE id = ?",o)),n.NextResponse.json({ok:!0})}catch(e){if(console.error("DELETE /api/usuarios/[id] error:",e),e?.code==="ER_ROW_IS_REFERENCED_2"||e?.errno===1451)return n.NextResponse.json({error:"FOREIGN_KEY_CONSTRAINT"},{status:409});return n.NextResponse.json({error:"INTERNAL_ERROR"},{status:500})}}let N=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/usuarios/[id]/route",pathname:"/api/usuarios/[id]",filename:"route",bundlePath:"app/api/usuarios/[id]/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\usuarios\\[id]\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:R,workUnitAsyncStorage:h,serverHooks:v}=N;function x(){return(0,s.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:h})}},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[7719,580,9942,4501,8318],()=>a(91540));module.exports=o})();