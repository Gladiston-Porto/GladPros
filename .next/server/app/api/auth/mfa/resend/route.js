(()=>{var e={};e.id=5359,e.ids=[5359],e.modules={1708:e=>{"use strict";e.exports=require("node:process")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{"use strict";e.exports=require("node:tty")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13641:(e,t,r)=>{"use strict";r.d(t,{z:()=>o.z});var o=r(31183)},14985:e=>{"use strict";e.exports=require("dns")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31183:(e,t,r)=>{"use strict";r.d(t,{z:()=>i});var o=r(29942);let i=global.__prisma??new o.PrismaClient({log:["error"]})},31421:e=>{"use strict";e.exports=require("node:child_process")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{"use strict";e.exports=require("node:os")},51455:e=>{"use strict";e.exports=require("node:fs/promises")},53501:(e,t,r)=>{"use strict";r.d(t,{q:()=>s});var o=r(55511),i=r.n(o),a=r(13641);class s{static get delegate(){try{return a.z.codigoMFA}catch{return}}static generateCode(){return Math.floor(1e5+9e5*Math.random()).toString()}static hashCode(e){return i().createHash("sha256").update(e).digest("hex")}static async createMFACode({usuarioId:e,tipoAcao:t="LOGIN",ip:r,userAgent:o}){this.delegate?.deleteMany?await this.delegate.deleteMany({where:{usuarioId:e,tipoAcao:t,OR:[{usado:!0},{expiresAt:{lt:new Date}}]}}):await a.z.$executeRaw`
        DELETE FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND (usado = TRUE OR expiresAt < NOW())
      `;let i=this.generateCode(),s=this.hashCode(i),n=new Date(Date.now()+3e5);if(this.delegate?.create)return{code:i,id:(await this.delegate.create({data:{usuarioId:e,codigo:s,tipoAcao:t,expiresAt:n,usado:!1,ip:r,userAgent:o},select:{id:!0}})).id};{await a.z.$executeRaw`
        INSERT INTO CodigoMFA (usuarioId, codigo, tipoAcao, expiresAt, ip, userAgent)
        VALUES (${e}, ${s}, ${t}, ${n}, ${r}, ${o})
      `;let u=await a.z.$queryRaw`
        SELECT id FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND tipoAcao = ${t}
        AND usado = FALSE
        ORDER BY criadoEm DESC
        LIMIT 1
      `;return{code:i,id:u[0]?.id||0}}}static async verifyMFACode({usuarioId:e,code:t,tipoAcao:r="LOGIN"}){let o=this.hashCode(t),i=this.delegate?.findFirst?await this.delegate.findFirst({where:{usuarioId:e,codigo:o,tipoAcao:r},orderBy:{criadoEm:"desc"},select:{id:!0,expiresAt:!0,usado:!0}}):(await a.z.$queryRaw`
          SELECT id, expiresAt, usado
          FROM CodigoMFA
          WHERE usuarioId = ${e}
          AND codigo = ${o}
          AND tipoAcao = ${r}
          ORDER BY criadoEm DESC
          LIMIT 1
        `)[0];return i?i.usado?{valid:!1,error:"C\xf3digo j\xe1 foi utilizado"}:new Date>i.expiresAt?{valid:!1,error:"C\xf3digo expirado"}:(this.delegate?.update?await this.delegate.update({where:{id:i.id},data:{usado:!0}}):await a.z.$executeRaw`
        UPDATE CodigoMFA SET usado = TRUE WHERE id = ${i.id}
      `,{valid:!0,codeId:i.id}):{valid:!1,error:"C\xf3digo inv\xe1lido"}}static async cleanupExpiredCodes(){return this.delegate?.deleteMany?(await this.delegate.deleteMany({where:{OR:[{usado:!0},{expiresAt:{lt:new Date}}]}})).count:Number(await a.z.$executeRaw`
        DELETE FROM CodigoMFA 
        WHERE expiresAt < NOW() OR usado = TRUE
      `)}static async countRecentAttempts(e,t=15){let r=new Date(Date.now()-60*t*1e3);if(this.delegate?.count)return await this.delegate.count({where:{usuarioId:e,criadoEm:{gt:r}}});{let t=await a.z.$queryRaw`
        SELECT COUNT(*) as count
        FROM CodigoMFA
        WHERE usuarioId = ${e}
        AND criadoEm > ${r}
      `;return t[0]?.count||0}}}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},69812:(e,t,r)=>{"use strict";r.d(t,{B0:()=>m,Dm:()=>A,E9:()=>x,KS:()=>E,PQ:()=>S,X5:()=>c,Zk:()=>h,cQ:()=>f,if:()=>R,rf:()=>l,tT:()=>g,yp:()=>I});var o=r(24501);let i=o.Yj().email("Email inv\xe1lido").max(255,"Email muito longo").toLowerCase().trim(),a=o.Yj().min(6,"Senha deve ter pelo menos 6 caracteres").max(128,"Senha muito longa").refine(e=>!!/[a-z]/.test(e)&&!!/[A-Z0-9]/.test(e),"Senha deve conter pelo menos: 1 letra min\xfascula e 1 mai\xfascula ou n\xfamero"),s=o.Yj().min(2,"Nome deve ter pelo menos 2 caracteres").max(100,"Nome muito longo").trim().refine(e=>/^[a-zA-ZÀ-ÿ\s]+$/.test(e),"Nome deve conter apenas letras e espa\xe7os"),n=o.Yj().length(4,"PIN deve ter exatamente 4 d\xedgitos").refine(e=>/^\d{4}$/.test(e),"PIN deve conter apenas n\xfameros"),u=o.Yj().length(6,"C\xf3digo MFA deve ter exatamente 6 d\xedgitos").refine(e=>/^\d{6}$/.test(e),"C\xf3digo MFA deve conter apenas n\xfameros"),d=o.Yj().min(5,"Pergunta de seguran\xe7a muito curta").max(200,"Pergunta de seguran\xe7a muito longa").trim(),p=o.Yj().min(2,"Resposta muito curta").max(100,"Resposta muito longa").trim().toLowerCase(),c=o.Ik({email:i,password:o.Yj().min(1,"Senha \xe9 obrigat\xf3ria")}),l=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),code:u,tipoAcao:o.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD"]).optional()}),m=o.Ik({email:i});o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),novaSenha:a,pin:n,perguntaSeguranca:d,respostaSeguranca:p});let g=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),newPassword:a,pin:n,securityQuestion:d,securityAnswer:p});o.Ik({token:o.Yj().min(1,"Token \xe9 obrigat\xf3rio"),novaSenha:a});let E=o.Ik({token:o.Yj().min(1,"Token \xe9 obrigat\xf3rio"),senha:a}),x=o.Ik({email:i}),A=o.Ik({email:i});o.Ik({nomeCompleto:s,email:i,tipo:o.k5(["ADMIN","USUARIO","CLIENTE"]),departamento:o.Yj().max(100,"Departamento muito longo").optional(),cargo:o.Yj().max(100,"Cargo muito longo").optional()}),o.Ik({nomeCompleto:s.optional(),email:i.optional(),tipo:o.k5(["ADMIN","USUARIO","CLIENTE"]).optional(),departamento:o.Yj().max(100,"Departamento muito longo").optional(),cargo:o.Yj().max(100,"Cargo muito longo").optional(),status:o.k5(["ATIVO","INATIVO","SUSPENSO"]).optional()}).refine(e=>Object.keys(e).length>0,"Pelo menos um campo deve ser fornecido para atualiza\xe7\xe3o");let I=o.gM("method",[o.Ik({method:o.eu("pin"),userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),pin:n}),o.Ik({method:o.eu("security"),userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),answer:p})]),h=o.Ik({userId:o.ai().int().positive("ID do usu\xe1rio inv\xe1lido"),tipoAcao:o.k5(["LOGIN","PRIMEIRO_ACESSO","RESET_PASSWORD","RESET","DESBLOQUEIO"]).optional()}),v=o.Ik({nomeCompleto:o.Yj().optional(),email:i,role:o.Yj().optional(),ativo:o.zM().optional(),criadoEm:o.KC([o.Yj(),o.ai(),o.p6()]).optional()}),R=o.Ik({filename:o.Yj().min(1).max(128).optional(),users:o.YO(v).min(1)}),f=o.Ik({email:i.optional(),nomeCompleto:s.optional(),role:o.k5(["ADMIN","GERENTE","USUARIO","FINANCEIRO","ESTOQUE","CLIENTE"]).optional(),status:o.k5(["ATIVO","INATIVO"]).optional(),telefone:o.Yj().max(32).optional().or(o.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=10&&t.length<=11},"Telefone deve ter entre 10 e 11 d\xedgitos. Exemplo: (11)99999-9999"),dataNascimento:o.KC([o.Yj(),o.p6()]).optional().transform(e=>{if(!e)return;if(e instanceof Date){if(isNaN(e.getTime()))return;let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${o}`}let t=String(e).trim();if(t.match(/^(\d{4})-(\d{2})-(\d{2})$/))return t;let r=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(r){let[,e,t,o]=r,i=parseInt(t,10),a=parseInt(e,10);if(a<1||a>12||i<1||i>31)return"INVALID_DATE";let s=t.padStart(2,"0"),n=e.padStart(2,"0");return`${o}-${n}-${s}`}return"INVALID_DATE"}).refine(e=>!e||"INVALID_DATE"!==e&&!isNaN(new Date(e+"T00:00:00.000Z").getTime()),"Data de nascimento inv\xe1lida. Use o formato MM/DD/YYYY (ex: 05/18/1979)"),endereco1:o.Yj().max(191).optional().or(o.eu("")).transform(e=>e||void 0),endereco2:o.Yj().max(191).optional().or(o.eu("")).transform(e=>e||void 0),cidade:o.Yj().max(96).optional().or(o.eu("")).transform(e=>e||void 0),estado:o.Yj().max(32).optional().or(o.eu("")).transform(e=>e||void 0),cep:o.Yj().max(16).optional().or(o.eu("")).transform(e=>e||void 0).refine(e=>{if(!e)return!0;let t=e.replace(/\D/g,"");return t.length>=5&&t.length<=9&&t===e.replace(/\D/g,"")},"CEP deve conter apenas n\xfameros. Exemplo: 01234567"),anotacoes:o.Yj().optional().or(o.eu("")).transform(e=>e&&e.trim().length>0?e:void 0)}),S=o.Ik({ativo:o.zM()})},73024:e=>{"use strict";e.exports=require("node:fs")},74075:e=>{"use strict";e.exports=require("zlib")},76760:e=>{"use strict";e.exports=require("node:path")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{},98555:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>l,serverHooks:()=>E,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var o={};r.r(o),r.d(o,{POST:()=>c});var i=r(96559),a=r(48088),s=r(37719),n=r(32190),u=r(13641),d=r(53501),p=r(69812);async function c(e){if("phase-production-build"===process.env.NEXT_PHASE||"phase-production-server"===process.env.NEXT_PHASE||"phase-static"===process.env.NEXT_PHASE||"phase-export"===process.env.NEXT_PHASE)return n.NextResponse.json({error:"Service temporarily unavailable"},{status:503});let t=e.headers.get("x-forwarded-for")?.split(",")[0]||e.headers.get("x-real-ip")||e.headers.get("cf-connecting-ip")||"unknown",o=e.headers.get("user-agent")||void 0;try{let i=await e.json().catch(()=>({})),a=p.Zk.safeParse(i);if(!a.success)return n.NextResponse.json({error:"ID do usu\xe1rio \xe9 obrigat\xf3rio"},{status:400});let{userId:s,tipoAcao:c="LOGIN"}=a.data,l=(await u.z.$queryRaw`
      SELECT id, email, nomeCompleto, primeiroAcesso, status
      FROM Usuario 
      WHERE id = ${s}
      LIMIT 1
    `)[0];if(!l)return n.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado"},{status:404});if("ATIVO"!==l.status)return n.NextResponse.json({error:"Conta inativa"},{status:401});if(await d.q.countRecentAttempts(s,15)>=3)return n.NextResponse.json({error:"Muitas solicita\xe7\xf5es. Aguarde 15 minutos antes de solicitar um novo c\xf3digo."},{status:429});let{code:m}=await d.q.createMFACode({usuarioId:l.id,tipoAcao:"RESET_PASSWORD"===c?"RESET":c,ip:t,userAgent:o}),{EmailService:g}=await Promise.all([r.e(9526),r.e(2849)]).then(r.bind(r,2849)),E=await g.sendMFA({to:l.email,userName:l.nomeCompleto,code:m,expiresInMinutes:5,isFirstAccess:l.primeiroAcesso});return E.success||console.error("[API] Erro ao enviar email MFA:",E.error),n.NextResponse.json({success:!0,message:"Novo c\xf3digo enviado com sucesso",email:l.email.replace(/(.{2})(.*)(@.*)/,"$1***$3")})}catch(e){return console.error("[API] MFA Resend error:",e),n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/auth/mfa/resend/route",pathname:"/api/auth/mfa/resend",filename:"route",bundlePath:"app/api/auth/mfa/resend/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\auth\\mfa\\resend\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:E}=l;function x(){return(0,s.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[7719,580,9942,4501],()=>r(98555));module.exports=o})();