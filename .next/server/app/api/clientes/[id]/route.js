"use strict";(()=>{var e={};e.id=7415,e.ids=[7415],e.modules={1708:e=>{e.exports=require("node:process")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{e.exports=require("node:tty")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12847:(e,t,o)=>{o.r(t),o.d(t,{patchFetch:()=>z,routeModule:()=>x,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>v});var r={};o.r(r),o.d(r,{DELETE:()=>g,GET:()=>f,PATCH:()=>N,PUT:()=>E});var a=o(96559),s=o(48088),n=o(37719),i=o(32190),l=o(13641),c=o(80969),d=o(7152),u=o(19015),p=o(78910),m=o(14250);async function f(e,t){try{let o=await (0,c.lE)(e,"canRead"),{id:r}=d.a0.parse(await t.params),a=await l.z.cliente.findUnique({where:{id:r},select:{id:!0,tipo:!0,nomeCompleto:!0,razaoSocial:!0,nomeFantasia:!0,email:!0,telefone:!0,nomeChave:!0,endereco1:!0,endereco2:!0,cidade:!0,estado:!0,zipcode:!0,status:!0,documentoEnc:!0,docLast4:!0,observacoes:!0,criadoEm:!0,atualizadoEm:!0}});if(!a)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let s={id:a.id,tipo:a.tipo,nomeCompleto:a.nomeCompleto,razaoSocial:a.razaoSocial,nomeFantasia:a.nomeFantasia,email:a.email,telefone:(0,u.sr)(a.telefone||""),endereco1:a.endereco1,endereco2:a.endereco2,cidade:a.cidade,estado:a.estado,zipcode:(0,u.oZ)(a.zipcode||""),observacoes:a.observacoes,ativo:"ATIVO"===a.status,documentoMasked:(0,u.bj)(a.docLast4||"",a.tipo),criadoEm:a.criadoEm.toISOString(),atualizadoEm:a.atualizadoEm.toISOString()};if(c.nS.canViewDocuments(o.role)&&a.documentoEnc)try{s.documento=await (0,p.wz)(a.documentoEnc)}catch(e){console.warn("Erro ao descriptografar documento:",e)}return i.NextResponse.json(s)}catch(e){if(console.error("[API] GET /api/clientes/[id] error:",e),e instanceof m.G)return i.NextResponse.json({error:"Par\xe2metros inv\xe1lidos",details:e.issues},{status:400});if(e instanceof Error){if("UNAUTHENTICATED"===e.message)return i.NextResponse.json({error:"N\xe3o autenticado"},{status:401});if("FORBIDDEN"===e.message)return i.NextResponse.json({error:"Sem permiss\xe3o para visualizar cliente"},{status:403})}return i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function E(e,t){try{let o,r=await (0,c.lE)(e,"canUpdate"),{id:a}=d.a0.parse(await t.params),s=await e.json(),n=d.pJ.parse(s),p=(0,u.G4)(n),m=await l.z.cliente.findUnique({where:{id:a},select:{id:!0,tipo:!0,nomeCompleto:!0,razaoSocial:!0,nomeFantasia:!0,email:!0,telefone:!0,endereco1:!0,endereco2:!0,cidade:!0,estado:!0,zipcode:!0,status:!0,docHash:!0,observacoes:!0}});if(!m)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let f={};for(let e of["nomeCompleto","razaoSocial","nomeFantasia","email","telefone","endereco1","endereco2","cidade","estado","zipcode","observacoes"])e in p&&void 0!==p[e]&&(f[e]=p[e]);if((p.nomeCompleto||p.razaoSocial||p.nomeFantasia)&&(f.nomeChave=p.nomeCompleto||p.nomeFantasia||p.razaoSocial||m.nomeCompleto||m.razaoSocial||""),"ativo"in n&&void 0!==n.ativo&&(f.status=n.ativo?"ATIVO":"INATIVO"),p.email&&p.email!==m.email){let e=await l.z.cliente.findFirst({where:{email:p.email,id:{not:a}},select:{id:!0,status:!0}});if(e){if("INATIVO"!==e.status)return i.NextResponse.json({error:"E-mail j\xe1 cadastrado no sistema"},{status:400});else if("string"==typeof p.email){let[t,o]=p.email.split("@"),r=`${t}+inativo-${e.id}@${o}`;await l.z.cliente.update({where:{id:e.id},data:{email:r}})}}}if(p.documento?o=p.documento:p.ssn?o=p.ssn:p.itin?o=p.itin:p.ein&&(o=p.ein),o){if(await (0,u.Jd)(o,a))return i.NextResponse.json({error:"Documento j\xe1 cadastrado no sistema"},{status:400});let{documentoEnc:e,docLast4:t,docHash:r}=await (0,u.Ku)(o,p.tipo||m.tipo);f.documentoEnc=e,f.docLast4=t,f.docHash=r}let E=await l.z.cliente.update({where:{id:a},data:f,select:{id:!0,tipo:!0,nomeCompleto:!0,razaoSocial:!0,nomeFantasia:!0,email:!0,telefone:!0,cidade:!0,estado:!0,zipcode:!0,docLast4:!0,status:!0,criadoEm:!0,atualizadoEm:!0}}),g=(0,u.gz)(m,{...p,status:f.status});Object.keys(g).length>0&&await (0,u.eA)(a,"UPDATE",g,Number(r.id));let N={id:E.id,tipo:E.tipo,nomeCompletoOuRazao:"PF"===E.tipo?E.nomeCompleto||"Nome n\xe3o informado":E.nomeFantasia||E.razaoSocial||"Raz\xe3o social n\xe3o informada",email:E.email,telefone:(0,u.sr)(E.telefone||""),cidade:E.cidade,estado:E.estado,zipcode:(0,u.oZ)(E.zipcode||""),documentoMasked:(0,u.bj)(E.docLast4||"",E.tipo),ativo:"ATIVO"===E.status,criadoEm:E.criadoEm.toISOString(),atualizadoEm:E.atualizadoEm.toISOString()};return i.NextResponse.json(N)}catch(e){if(console.error("[API] PUT /api/clientes/[id] error:",e),e&&"object"==typeof e&&"P2002"===e.code){let t=e.meta?.target,o="Dados duplicados";return Array.isArray(t)?t.includes("email")?o="E-mail j\xe1 cadastrado no sistema":t.includes("docHash")?o="Documento j\xe1 cadastrado no sistema":t.includes("nomeChave")&&t.includes("telefone")&&(o="J\xe1 existe cliente com o mesmo nome e telefone"):"string"==typeof t&&(t.includes("email")?o="E-mail j\xe1 cadastrado no sistema":t.includes("docHash")?o="Documento j\xe1 cadastrado no sistema":t.includes("nomeChave")&&t.includes("telefone")&&(o="J\xe1 existe cliente com o mesmo nome e telefone")),i.NextResponse.json({error:o},{status:400})}if(e instanceof m.G)return i.NextResponse.json({error:"Dados inv\xe1lidos",details:e.issues},{status:400});if(e instanceof Error){if("UNAUTHENTICATED"===e.message)return i.NextResponse.json({error:"N\xe3o autenticado"},{status:401});if("FORBIDDEN"===e.message)return i.NextResponse.json({error:"Sem permiss\xe3o para atualizar cliente"},{status:403})}return i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function g(e,t){try{let o=await (0,c.lE)(e,"canDelete"),{id:r}=d.a0.parse(await t.params),a=await l.z.cliente.findUnique({where:{id:r},select:{id:!0,status:!0,nomeCompleto:!0,razaoSocial:!0}});if(!a)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});if("INATIVO"===a.status)return await (0,u.eA)(r,"DELETE",{status:{old:"INATIVO",new:"INATIVO"}},Number(o.id)),i.NextResponse.json({message:"Cliente j\xe1 estava inativo",id:r});return await l.z.cliente.update({where:{id:r},data:{status:"INATIVO"}}),await (0,u.eA)(r,"DELETE",{status:{old:"ATIVO",new:"INATIVO"}},Number(o.id)),i.NextResponse.json({message:"Cliente inativado com sucesso",id:r})}catch(e){if(console.error("[API] DELETE /api/clientes/[id] error:",e),e instanceof m.G)return i.NextResponse.json({error:"Par\xe2metros inv\xe1lidos",details:e.issues},{status:400});if(e instanceof Error){if("UNAUTHENTICATED"===e.message)return i.NextResponse.json({error:"N\xe3o autenticado"},{status:401});if("FORBIDDEN"===e.message)return i.NextResponse.json({error:"Sem permiss\xe3o para inativar cliente"},{status:403})}return i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function N(e,t){try{let o=await (0,c.lE)(e,"canUpdate"),{id:r}=d.a0.parse(await t.params),a=await e.json().catch(()=>({})),s="boolean"==typeof a?.ativo?a.ativo:void 0;if(void 0===s)return i.NextResponse.json({error:'Par\xe2metro "ativo" \xe9 obrigat\xf3rio e deve ser booleano'},{status:400});let n=await l.z.cliente.findUnique({where:{id:r},select:{id:!0,status:!0}});if(!n)return i.NextResponse.json({error:"Cliente n\xe3o encontrado"},{status:404});let p=s?"ATIVO":"INATIVO";if(n.status===p)return i.NextResponse.json({id:r,ativo:s,message:"Status j\xe1 estava definido"});let m=await l.z.cliente.update({where:{id:r},data:{status:p}});return await (0,u.eA)(r,"UPDATE",{status:{old:n.status,new:p}},Number(o.id)),i.NextResponse.json({id:m.id,ativo:"ATIVO"===m.status})}catch(e){if(console.error("[API] PATCH /api/clientes/[id] error:",e),e instanceof m.G)return i.NextResponse.json({error:"Par\xe2metros inv\xe1lidos",details:e.issues},{status:400});if(e instanceof Error){if("UNAUTHENTICATED"===e.message)return i.NextResponse.json({error:"N\xe3o autenticado"},{status:401});if("FORBIDDEN"===e.message)return i.NextResponse.json({error:"Sem permiss\xe3o para atualizar status de cliente"},{status:403})}return i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let x=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/clientes/[id]/route",pathname:"/api/clientes/[id]",filename:"route",bundlePath:"app/api/clientes/[id]/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\clientes\\[id]\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:h,workUnitAsyncStorage:v,serverHooks:w}=x;function z(){return(0,n.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:v})}},16698:e=>{e.exports=require("node:async_hooks")},19015:(e,t,o)=>{o.d(t,{G4:()=>d,Jd:()=>u,Ku:()=>c,bj:()=>n,eA:()=>p,gz:()=>m,oZ:()=>l,sr:()=>i});var r=o(78910),a=o(13641),s=o(18260);function n(e,t){if(!e)return"";let o=e.replace(/\D/g,"");if(o.length<11&&"PF"===t||o.length<14&&"PJ"===t)return e;if(o.length<=4){let e=o.padStart(4,"*");return"PF"===t?`***-**-${e}`:`**-***${e}`}if("PF"===t){if(11===o.length)return`${o.slice(0,3)}.${o.slice(3,6)}.${o.slice(6,9)}-${o.slice(9)}`}else if(14===o.length)return`${o.slice(0,2)}.${o.slice(2,5)}.${o.slice(5,8)}/${o.slice(8,12)}-${o.slice(12)}`;return e}function i(e){if(!e)return"";let t=e.replace(/\D/g,"");return 11===t.length?`(${t.slice(0,2)}) ${t.slice(2,7)}-${t.slice(7)}`:10===t.length?`(${t.slice(0,2)}) ${t.slice(2,6)}-${t.slice(6)}`:e}function l(e){if(!e)return"";let t=e.replace(/\D/g,"");return 8===t.length||9===t.length?`${t.slice(0,5)}-${t.slice(5)}`:5===t.length?t:e}async function c(e,t){let o=await (0,r.is)(e);return{documentoEnc:o,docLast4:(0,r.nK)(e),docHash:(0,r.qZ)(e)}}function d(e){let t=e||{},o=e=>"string"==typeof e?e:null==e?null:String(e),r=o(t.nomeCompleto)?.trim()||null,a=o(t.razaoSocial)?.trim()||null,s=o(t.nomeFantasia)?.trim()||null,n=o(t.email)?.trim().toLowerCase()||null,i=o(t.telefone)?.replace(/\D/g,"")||null,l=t.tipoDocumentoPF??null,c=o(t.ssn)?o(t.ssn).replace(/\D/g,""):null,d=o(t.itin)?o(t.itin).replace(/\D/g,""):null,u=o(t.ein)?o(t.ein).replace(/\D/g,""):null,p=o(t.endereco1)?.trim()||null,m=o(t.endereco2)?.trim()||null,f=o(t.cidade)?.trim()||null,E=o(t.estado)?.trim()||null,g=o(t.zipcode)?.replace(/\D/g,"")||null,N=o(t.observacoes)?.trim()||null,x=o(t.documento)?.replace(/\D/g,"")||null;return{...t,nomeCompleto:r,razaoSocial:a,nomeFantasia:s,email:n,telefone:i,tipoDocumentoPF:l,ssn:c,itin:d,ein:u,endereco1:p,endereco2:m,cidade:f,estado:E,zipcode:g,documento:x,observacoes:N}}async function u(e,t){if(!e)return!1;let o=(0,r.qZ)(e);return!!a.z&&!!a.z.cliente&&"function"==typeof a.z.cliente.findFirst&&!!await a.z.cliente.findFirst({where:{docHash:o,id:t?{not:t}:void 0},select:{id:!0}})}async function p(e,t,o,r){return s.d.logAction(r,"Cliente",e,t,o)}function m(e,t){let o={};for(let r of["tipo","nomeCompleto","razaoSocial","nomeFantasia","email","telefone","endereco1","endereco2","cidade","estado","zipcode","observacoes","status"]){let a=e[r],s=t[r];a!==s&&(o[r]={old:a,new:s})}return e.docHash!==t.docHash&&(o.documento={old:"[DOCUMENTO]",new:"[DOCUMENTO ALTERADO]"}),o}},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31421:e=>{e.exports=require("node:child_process")},33873:e=>{e.exports=require("path")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{e.exports=require("node:os")},51455:e=>{e.exports=require("node:fs/promises")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{e.exports=require("node:fs")},76760:e=>{e.exports=require("node:path")},77598:e=>{e.exports=require("node:crypto")},78474:e=>{e.exports=require("node:events")},78910:(e,t,o)=>{o.d(t,{is:()=>l,nK:()=>p,qZ:()=>u,wz:()=>c});var r=o(77598),a=o.n(r);let s="PbE3VcAyP30aTLnd18EE947FvZ8ttn0YGPIEGtbMtsU=";if(!s)throw Error("Missing CLIENT_DOC_ENCRYPTION_KEY_BASE64");let n=Buffer.from(s,"base64");if(32!==n.length)throw Error("CLIENT_DOC_ENCRYPTION_KEY_BASE64 must decode to 32 bytes");let i="Ah72WaEOIS79EgFMo/7RcCsW0RgyEga2fKgsvzks0yk=".split(",").map(e=>e.trim()).filter(Boolean).map(e=>Buffer.from(e,"base64")).filter(e=>32===e.length);function l(e){let t=a().randomBytes(12),o=a().createCipheriv("aes-256-gcm",n,t),r=Buffer.concat([o.update(e,"utf8"),o.final()]),s=o.getAuthTag();return Buffer.concat([t,s,r]).toString("base64")}function c(e){let t=Buffer.from(e,"base64"),o=t.subarray(0,12),r=t.subarray(12,28),s=t.subarray(28);for(let e of[n,...i])try{let t=a().createDecipheriv("aes-256-gcm",e,o);return t.setAuthTag(r),Buffer.concat([t.update(s),t.final()]).toString("utf8")}catch{}throw Error("DECRYPT_FAILED")}function d(e){return e.replace(/[^0-9A-Za-z]/g,"").toUpperCase()}function u(e){let t=d(e);return a().createHash("sha256").update(t).digest("hex")}function p(e){return d(e).slice(-4)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[7719,580,9942,4501,4553,4629],()=>o(12847));module.exports=r})();