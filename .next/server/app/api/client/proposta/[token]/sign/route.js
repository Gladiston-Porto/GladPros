(()=>{var o={};o.id=9456,o.ids=[9456],o.modules={3295:o=>{"use strict";o.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:o=>{"use strict";o.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14985:o=>{"use strict";o.exports=require("dns")},21820:o=>{"use strict";o.exports=require("os")},26476:(o,a,e)=>{"use strict";e.d(a,{f6:()=>t,pQ:()=>i});var t=function(o){return o.RASCUNHO="RASCUNHO",o.ENVIADA="ENVIADA",o.ASSINADA="ASSINADA",o.APROVADA="APROVADA",o.CANCELADA="CANCELADA",o}({}),i=function(o){return o.CREATED="CREATED",o.UPDATED="UPDATED",o.SENT="SENT",o.SIGNED="SIGNED",o.APPROVED="APPROVED",o.CANCELLED="CANCELLED",o.ATTACH_ADDED="ATTACH_ADDED",o.ATTACH_REMOVED="ATTACH_REMOVED",o}({})},27910:o=>{"use strict";o.exports=require("stream")},28354:o=>{"use strict";o.exports=require("util")},29021:o=>{"use strict";o.exports=require("fs")},29294:o=>{"use strict";o.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:o=>{"use strict";o.exports=require("path")},33911:(o,a,e)=>{"use strict";e.d(a,{db:()=>s});class t{constructor(o){this.proposta={},this.propostaLog={},this.propostaEtapa={},this.propostaMaterial={},this.cliente={},this.usuario={}}$connect(){return Promise.resolve()}$disconnect(){return Promise.resolve()}$transaction(o){return o({})}generatePropostaNumber(){let o=new Date,a=o.getFullYear(),e=String(o.getMonth()+1).padStart(2,"0"),t=String(o.getDate()).padStart(2,"0"),i=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return Promise.resolve(`PROP-${a}${e}${t}-${i}`)}}let i=globalThis;class r extends t{async generatePropostaNumber(){let o=new Date,a=o.getFullYear(),e=String(o.getMonth()+1).padStart(2,"0"),t=String(o.getDate()).padStart(2,"0"),i=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`PROP-${a}${e}${t}-${i}`}}let s=i.prisma??new r},34631:o=>{"use strict";o.exports=require("tls")},44870:o=>{"use strict";o.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45453:(o,a,e)=>{"use strict";e.d(a,{A:()=>r});var t=e(49526);class i{constructor(){let o={host:process.env.SMTP_HOST||"localhost",port:parseInt(process.env.SMTP_PORT||"587"),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER||"",pass:process.env.SMTP_PASS||""}};this.transporter=t.createTransport(o)}async sendEmail({to:o,subject:a,html:e,cc:t,bcc:i}){try{let r=await this.transporter.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:o,cc:t,bcc:i,subject:a,html:e});return{success:!0,messageId:r.messageId}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Erro desconhecido"}}}async sendProposalSignedNotification(o,a){let e=`Proposta ${o?.numeroProposta??""} foi assinada pelo cliente`,t=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: #4f46e5; color: white; padding: 20px; text-align: center;">
          <h1>Proposta Assinada</h1>
        </div>
        
        <div style="padding: 20px; background: #f9fafb;">
          <h2>Boa not\xedcia!</h2>
          <p>A proposta <strong>${o?.numeroProposta??""}</strong> foi assinada pelo cliente.</p>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h3>Detalhes da Proposta:</h3>
            <ul style="line-height: 1.6;">
              <li><strong>N\0mero:</strong> ${o?.numeroProposta??""}</li>
              <li><strong>Cliente:</strong> ${o?.cliente?.nome||"N/A"}</li>
              <li><strong>Valor:</strong> ${o?.valorEstimado?`$${o.valorEstimado.toLocaleString()}`:"N/A"}</li>
              <li><strong>Assinado por:</strong> ${a}</li>
              <li><strong>Data da assinatura:</strong> ${new Date().toLocaleString("pt-BR")}</li>
            </ul>
          </div>
          
          <p>A proposta agora est\xe1 no status <strong>ASSINADA</strong> e est\xe1 pronta para aprova\xe7\xe3o.</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${process.env.NEXTAUTH_URL}/propostas/${o?.id??""}" 
               style="background: #4f46e5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              Ver Proposta no Sistema
            </a>
          </div>
        </div>
        
        <div style="padding: 20px; text-align: center; color: #6b7280; font-size: 14px;">
          <p>GladPros - Sistema de Gest\xe3o de Propostas</p>
          <p>Este \xe9 um email autom\xe1tico, n\xe3o responda a esta mensagem.</p>
        </div>
      </div>
    `;for(let o of process.env.PROPOSAL_NOTIFICATION_EMAILS?.split(",")||["admin@gladpros.com"])await this.sendEmail({to:o.trim(),subject:e,html:t})}async sendProposalSentNotification(o,a){let e=`Nova proposta comercial para sua an\0lise - ${o?.numeroProposta??""}`,t=`${process.env.NEXTAUTH_URL}/p/${o?.numeroProposta??""}`,i=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: #059669; color: white; padding: 20px; text-align: center;">
          <h1>Nova Proposta Comercial</h1>
        </div>
        
        <div style="padding: 20px; background: #f0fdf4;">
          <h2>Ol\xe1!</h2>
          <p>Voc\xea recebeu uma nova proposta comercial da GladPros.</p>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h3>Detalhes da Proposta:</h3>
            <ul style="line-height: 1.6;">
              <li><strong>N\0mero:</strong> ${o?.numeroProposta??""}</li>
              <li><strong>Descri\0\0o:</strong> ${o?.descricao??""}</li>
              <li><strong>Valor Estimado:</strong> ${o?.valorEstimado?`$${o.valorEstimado.toLocaleString()}`:"A consultar"}</li>
              <li><strong>Data de Cria\0\0o:</strong> ${o?.dataCriacao?new Date(o.dataCriacao).toLocaleDateString("pt-BR"):""}</li>
            </ul>
          </div>
          
          <p>Para visualizar todos os detalhes e assinar a proposta, clique no bot\xe3o abaixo:</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${t}" 
               style="background: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              Visualizar e Assinar Proposta
            </a>
          </div>
          
          <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p><strong>Importante:</strong> Este link \xe9 \xfanico e pessoal. N\xe3o compartilhe com terceiros.</p>
          </div>
        </div>
        
        <div style="padding: 20px; text-align: center; color: #6b7280; font-size: 14px;">
          <p>GladPros - Sistema de Gest\xe3o de Propostas</p>
          <p>Em caso de d\xfavidas, entre em contato conosco.</p>
        </div>
      </div>
    `;return await this.sendEmail({to:a,subject:e,html:i})}}let r=new i},55511:o=>{"use strict";o.exports=require("crypto")},55591:o=>{"use strict";o.exports=require("https")},63033:o=>{"use strict";o.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:o=>{"use strict";o.exports=require("zlib")},78335:()=>{},78506:(o,a,e)=>{"use strict";e.d(a,{SF:()=>i}),e(55511);var t=e(33911);async function i(o){return o&&64===o.length?await t.db.proposta.findFirst({where:{tokenPublico:o,tokenExpiresAt:{gt:new Date},deletedAt:null,status:{in:["ENVIADA","ASSINADA"]}},include:{cliente:{select:{id:!0,nomeCompleto:!0,razaoSocial:!0,email:!0}},etapas:{orderBy:{ordem:"asc"}},materiais:{orderBy:{nome:"asc"}},anexos:{where:{privado:!1},orderBy:{criadoEm:"asc"}}}}):null}},79551:o=>{"use strict";o.exports=require("url")},79646:o=>{"use strict";o.exports=require("child_process")},81630:o=>{"use strict";o.exports=require("http")},91645:o=>{"use strict";o.exports=require("net")},94735:o=>{"use strict";o.exports=require("events")},96269:(o,a,e)=>{"use strict";e.r(a),e.d(a,{patchFetch:()=>k,routeModule:()=>N,serverHooks:()=>C,workAsyncStorage:()=>I,workUnitAsyncStorage:()=>b});var t={};e.r(t),e.d(t,{POST:()=>D});var i=e(96559),r=e(48088),s=e(37719),n=e(32190),p=e(14250),l=e(33911),d=e(26476),c=e(78506),u=e(45453),m=e(24501);let g=m.k5(["RASCUNHO","ENVIADA","ASSINADA","APROVADA","CANCELADA"]),A=m.k5(["SIM","NAO"]),x=m.k5(["PLANEJADA","EM_ANDAMENTO","CONCLUIDA"]),j=m.k5(["PLANEJADO","SUBSTITUIDO","REMOVIDO"]),E=m.k5(["CANVAS","CHECKBOX","NOME_CHECKBOX"]),Y=m.k5(["NA_APROVACAO","POR_MARCOS","NA_ENTREGA","CUSTOMIZADO"]),v=m.k5(["PIX","CARTAO","BOLETO","TRANSFERENCIA","DINHEIRO","CHEQUE"]),P=m.Ik({custoMaterialEstimado:m.ai().min(0).optional(),custoMaoObraEstimado:m.ai().min(0).optional(),horasMaoObraEstimadas:m.ai().min(0).optional(),custoTerceirosEstimado:m.ai().min(0).optional(),overheadPercentual:m.ai().min(0).max(100).optional(),margemDesejadaPercentual:m.ai().min(0).max(100).optional(),impostosPercentual:m.ai().min(0).max(100).optional(),contingenciaPercentual:m.ai().min(0).max(100).optional(),freteLogisticaEstimado:m.ai().min(0).optional(),totalEstimadoInterno:m.ai().min(0).optional()}).optional(),f=m.YO(m.Ik({etapa:m.Yj(),percentual:m.ai().min(0).max(100),descricao:m.Yj().optional()})).optional(),S=m.YO(m.Ik({nome:m.Yj(),descricao:m.Yj().optional(),valorAdicional:m.ai().optional(),incluso:m.zM().default(!1)})).optional();m.Ik({clienteId:m.ai().int().positive("Cliente \xe9 obrigat\xf3rio"),contatoNome:m.Yj().min(1,"Nome do contato \xe9 obrigat\xf3rio").max(255),contatoEmail:m.Yj().email("Email inv\xe1lido").max(255),contatoTelefone:m.Yj().max(50).optional(),localExecucaoEndereco:m.Yj().min(1,"Endere\xe7o de execu\xe7\xe3o \xe9 obrigat\xf3rio"),titulo:m.Yj().min(1,"T\xedtulo \xe9 obrigat\xf3rio").max(500),descricaoEscopo:m.Yj().min(1,"Descri\xe7\xe3o do escopo \xe9 obrigat\xf3ria"),tipoServico:m.Yj().min(1,"Tipo de servi\xe7o \xe9 obrigat\xf3rio").max(255),tempoParaAceite:m.ai().int().min(1).max(365).optional(),validadeProposta:m.Yj().datetime().optional().transform(o=>o?new Date(o):void 0),prazoExecucaoEstimadoDias:m.ai().int().min(1).optional(),janelaExecucaoPreferencial:m.Yj().optional(),restricoesDeAcesso:m.Yj().optional(),permite:A,quaisPermites:m.Yj().optional(),normasReferencias:m.Yj().optional(),inspecoesNecessarias:m.Yj().optional(),condicoesPagamento:m.g1(m.Yj(),m.bz()).optional(),garantia:m.Yj().optional(),exclusoes:m.Yj().optional(),condicoesGerais:m.Yj().optional(),descontosOfertados:m.ai().min(0).max(100).optional(),opcoesAlternativas:S,valorEstimado:m.ai().min(0).optional().transform(o=>o?Number(o):void 0),internalEstimate:P,precoPropostaCliente:m.ai().min(0).optional(),gatilhoFaturamento:Y.optional(),percentualSinal:m.ai().min(0).max(100).optional(),marcosPagamento:f,formaPagamentoPreferida:v.optional(),instrucoesPagamento:m.Yj().optional(),multaAtraso:m.Yj().optional(),descontosCondicionais:m.Yj().optional(),observacoesInternas:m.Yj().optional(),observacoesParaCliente:m.Yj().optional(),riscosIdentificados:m.Yj().optional(),etapas:m.YO(m.Ik({servico:m.Yj().min(1,"Servi\xe7o \xe9 obrigat\xf3rio"),descricao:m.Yj().min(1,"Descri\xe7\xe3o \xe9 obrigat\xf3ria"),quantidade:m.ai().min(0).optional(),unidade:m.Yj().optional(),duracaoEstimadaHoras:m.ai().min(0).optional(),custoMaoObraEstimado:m.ai().min(0).optional(),status:x.default("PLANEJADA"),ordem:m.ai().int().min(0).default(0),dependencias:m.Yj().optional()})).default([]),materiais:m.YO(m.Ik({codigo:m.Yj().optional(),nome:m.Yj().min(1,"Nome do material \xe9 obrigat\xf3rio"),quantidade:m.ai().min(0,"Quantidade deve ser maior que zero").default(0),unidade:m.Yj().optional(),status:j.default("PLANEJADO"),observacao:m.Yj().optional(),precoUnitario:m.ai().min(0).optional(),fornecedorPreferencial:m.Yj().optional(),moeda:m.Yj().default("USD")})).default([])}).refine(o=>"SIM"!==o.permite||!!o.quaisPermites?.trim(),{message:'Campo "Quais permites" \xe9 obrigat\xf3rio quando permite = SIM',path:["quaisPermites"]}).partial().extend({id:m.ai().int().positive(),status:g.optional()}),m.Ik({status:g.optional(),clienteId:m.ai().int().positive().optional(),search:m.Yj().optional(),dateFrom:m.Yj().optional(),dateTo:m.Yj().optional(),page:m.ai().int().min(1).default(1),pageSize:m.ai().int().min(1).max(100).default(25),cursor:m.Yj().optional(),sortKey:m.k5(["dataCriacao","numeroProposta","status","valorEstimado","criadoEm","titulo","cliente","valor"]).default("dataCriacao"),sortDir:m.k5(["asc","desc"]).default("desc")});let h=m.Ik({assinaturaTipo:E.default("CANVAS"),assinaturaCliente:m.Yj().min(1,"Nome do signat\xe1rio \xe9 obrigat\xf3rio"),assinaturaImagem:m.Yj().optional(),aceiteTermos:m.zM().refine(o=>!0===o,"Deve aceitar os termos"),ip:m.Yj().optional(),userAgent:m.Yj().optional()});async function D(o,{params:a}){try{let e=a.token,t=await o.json(),{assinaturaTipo:i,assinaturaCliente:r,assinaturaImagem:s,ip:p,userAgent:m}=h.parse(t),g=await (0,c.SF)(e);if(!g)return n.NextResponse.json({error:"Proposta n\xe3o encontrada ou token expirado"},{status:404});if(g.status!==d.f6.ENVIADA)return n.NextResponse.json({error:"Proposta n\xe3o est\xe1 dispon\xedvel para assinatura"},{status:400});let A=p||o.headers.get("x-forwarded-for")||o.headers.get("x-real-ip")||"unknown",x=m||o.headers.get("user-agent")||"unknown",j=await l.db.proposta.update({where:{id:g.id},data:{status:d.f6.ASSINADA,assinaturaTipo:i,assinadoEm:new Date,assinaturaCliente:r,assinaturaImagem:"CANVAS"===i?s:null,assinaturaIp:A,assinaturaUserAgent:x,updatedAt:new Date}});await l.db.propostaLog.create({data:{propostaId:g.id,actorId:null,action:"SIGNED",newJson:{assinaturaTipo:i,assinaturaCliente:r,status:"ASSINADA"},ip:A,userAgent:x,createdAt:new Date}});try{await u.A.sendProposalSignedNotification(j,r)}catch(o){console.error("Error sending email notification:",o)}return n.NextResponse.json({success:!0,message:"Proposta assinada com sucesso",proposta:{id:j.id,numeroProposta:j.numeroProposta,status:j.status,assinadaEm:j.assinadoEm}})}catch(o){if(console.error("Error signing proposal:",o),o instanceof p.G)return n.NextResponse.json({error:"Dados inv\xe1lidos",details:o.issues.map(o=>String(o.message))},{status:400});return n.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}m.Ik({gerarToken:m.zM().default(!0),diasExpiracao:m.ai().int().min(1).max(365).default(30)}),m.Ik({filename:m.Yj().min(1),mime:m.Yj().min(1),size:m.ai().max(0xa00000,"Arquivo deve ter no m\xe1ximo 10MB"),privado:m.zM().default(!1),descricao:m.Yj().optional()}),m.Ik({assinaturaResponsavel:m.Yj().min(1,"Assinatura do respons\xe1vel \xe9 obrigat\xf3ria"),observacoes:m.Yj().optional()}),m.Ik({motivo:m.Yj().min(1,"Motivo do cancelamento \xe9 obrigat\xf3rio"),observacoes:m.Yj().optional()}),m.Ik({id:m.ai(),numeroProposta:m.Yj(),clienteId:m.ai(),contatoNome:m.Yj(),contatoEmail:m.Yj(),contatoTelefone:m.Yj().optional(),localExecucaoEndereco:m.Yj(),titulo:m.Yj(),descricaoEscopo:m.Yj(),tipoServico:m.Yj(),dataCriacao:m.Yj(),tempoParaAceite:m.ai().optional(),validadeProposta:m.Yj().optional(),prazoExecucaoEstimadoDias:m.ai().optional(),janelaExecucaoPreferencial:m.Yj().optional(),restricoesDeAcesso:m.Yj().optional(),permite:A,quaisPermites:m.Yj().optional(),normasReferencias:m.Yj().optional(),inspecoesNecessarias:m.Yj().optional(),condicoesPagamento:m.g1(m.Yj(),m.bz()).optional(),garantia:m.Yj().optional(),exclusoes:m.Yj().optional(),condicoesGerais:m.Yj().optional(),descontosOfertados:m.ai().optional(),opcoesAlternativas:m.bz().optional(),valorEstimado:m.KC([m.ai(),m.Yj()]).optional(),precoPropostaCliente:m.KC([m.ai(),m.Yj()]).optional(),gatilhoFaturamento:Y.optional(),percentualSinal:m.ai().optional(),marcosPagamento:m.bz().optional(),formaPagamentoPreferida:v.optional(),instrucoesPagamento:m.Yj().optional(),multaAtraso:m.Yj().optional(),descontosCondicionais:m.Yj().optional(),status:g,enviadaParaOCliente:m.Yj().optional(),tokenPublico:m.Yj().optional(),tokenExpiresAt:m.Yj().optional(),assinaturaTipo:E.optional(),assinaturaCliente:m.Yj().optional(),assinadaEm:m.Yj().optional(),assinaturaResponsavel:m.Yj().optional(),aprovacaoInternaTecnica:m.zM().optional(),aprovacaoInternaFinanceira:m.zM().optional(),observacoesParaCliente:m.Yj().optional(),riscosIdentificados:m.Yj().optional(),criadoEm:m.Yj(),atualizadoEm:m.Yj(),cliente:m.Ik({id:m.ai(),nomeCompleto:m.Yj().optional(),razaoSocial:m.Yj().optional(),email:m.Yj()}).optional(),etapas:m.YO(m.Ik({id:m.ai(),servico:m.Yj(),descricao:m.Yj(),quantidade:m.ai().optional(),unidade:m.Yj().optional(),duracaoEstimadaHoras:m.ai().optional(),custoMaoObraEstimado:m.KC([m.ai(),m.Yj()]).optional(),status:x,ordem:m.ai(),dependencias:m.Yj().optional()})).optional(),materiais:m.YO(m.Ik({id:m.ai(),codigo:m.Yj().optional(),nome:m.Yj(),quantidade:m.ai(),unidade:m.Yj().optional(),status:j,observacao:m.Yj().optional(),precoUnitario:m.KC([m.ai(),m.Yj()]).optional(),fornecedorPreferencial:m.Yj().optional(),totalItem:m.KC([m.ai(),m.Yj()]).optional()})).optional(),anexos:m.YO(m.Ik({id:m.ai(),filename:m.Yj(),mime:m.Yj(),privado:m.zM().optional(),descricao:m.Yj().optional(),criadoEm:m.Yj()})).optional(),canViewInternalValues:m.zM().optional(),canEdit:m.zM().optional(),canApprove:m.zM().optional()});let N=new i.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/client/proposta/[token]/sign/route",pathname:"/api/client/proposta/[token]/sign",filename:"route",bundlePath:"app/api/client/proposta/[token]/sign/route"},resolvedPagePath:"C:\\Users\\gladi\\Documents\\gladpros-nextjs\\src\\app\\api\\client\\proposta\\[token]\\sign\\route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:I,workUnitAsyncStorage:b,serverHooks:C}=N;function k(){return(0,s.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:b})}},96487:()=>{}};var a=require("../../../../../../webpack-runtime.js");a.C(o);var e=o=>a(a.s=o),t=a.X(0,[7719,580,4501,9526],()=>e(96269));module.exports=t})();