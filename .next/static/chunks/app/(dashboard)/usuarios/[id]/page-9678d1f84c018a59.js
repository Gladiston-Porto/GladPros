(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4080],{6654:(e,s,a)=>{"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"useMergedRef",{enumerable:!0,get:function(){return t}});let r=a(12115);function t(e,s){let a=(0,r.useRef)(null),t=(0,r.useRef)(null);return(0,r.useCallback)(r=>{if(null===r){let e=a.current;e&&(a.current=null,e());let s=t.current;s&&(t.current=null,s())}else e&&(a.current=i(e,r)),s&&(t.current=i(s,r))},[e,s])}function i(e,s){if("function"!=typeof e)return e.current=s,()=>{e.current=null};{let a=e(s);return"function"==typeof a?a:()=>e(null)}}("function"==typeof s.default||"object"==typeof s.default&&null!==s.default)&&void 0===s.default.__esModule&&(Object.defineProperty(s.default,"__esModule",{value:!0}),Object.assign(s.default,s),e.exports=s.default)},11214:(e,s,a)=>{Promise.resolve().then(a.bind(a,16088))},16088:(e,s,a)=>{"use strict";a.d(s,{default:()=>m});var r=a(95155),t=a(12115),i=a(6874),l=a.n(i),n=a(10491);function d(e){let{userId:s}=e,[a,i]=(0,t.useState)([]),[l,n]=(0,t.useState)([]),[d,o]=(0,t.useState)(!0),[c,u]=(0,t.useState)(!0),[x,m]=(0,t.useState)(null),h=(0,t.useCallback)(async()=>{try{o(!0);let e=await fetch("/api/usuarios/".concat(s,"/sessions"));if(e.ok){let s=await e.json();i(s.sessions||[])}}catch(e){console.error("Erro ao carregar sess\xf5es")}finally{o(!1)}},[s]),g=(0,t.useCallback)(async()=>{try{u(!0);let e=await fetch("/api/security/reports?type=login-attempts&userId=".concat(s));if(e.ok){let s=await e.json();n(s.results||[])}}catch(e){console.error("Erro ao carregar tentativas")}finally{u(!1)}},[s]),p=(0,t.useCallback)(async()=>{try{let e=await fetch("/api/usuarios/".concat(s,"/security"));if(e.ok){let s=await e.json();m({blocked:!!s.blocked,lastSuccessfulLoginAt:s.lastSuccessfulLoginAt||null})}}catch(e){console.error("Erro ao carregar status de seguran\xe7a:")}},[s]);(0,t.useEffect)(()=>{h(),g(),p()},[h,g,p]);let b=async e=>{try{(await fetch("/api/usuarios/sessions/".concat(e),{method:"DELETE"})).ok&&await h()}catch(e){console.error("Erro ao revogar sess\xe3o:",e)}},j=async()=>{if(confirm("Tem certeza que deseja encerrar todas as sess\xf5es ativas deste usu\xe1rio?"))try{(await fetch("/api/usuarios/".concat(s,"/sessions"),{method:"DELETE"})).ok&&await h()}catch(e){console.error("Erro ao revogar todas as sess\xf5es:",e)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"rounded-2xl border border-black/10 bg-white p-4 dark:border-white/10 dark:bg-white/5",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h3",{className:"font-semibold text-lg",children:"Sess\xf5es Ativas"}),a.length>0&&(0,r.jsx)("button",{onClick:j,className:"text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600",children:"\uD83D\uDEAB Revogar Todas"})]}),d?(0,r.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"}),(0,r.jsx)("span",{className:"ml-2",children:"Carregando sess\xf5es..."})]}):0===a.length?(0,r.jsx)("div",{className:"text-gray-500 py-4",children:"Nenhuma sess\xe3o ativa encontrada."}):(0,r.jsx)("div",{className:"space-y-3",children:a.map(e=>{var s;return(0,r.jsx)("div",{className:"border rounded-lg p-3 bg-gray-50",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),(0,r.jsx)("span",{className:"font-medium",children:"Sess\xe3o Ativa"}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:["Token: ",null==(s=e.token)?void 0:s.substring(0,8),"..."]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"IP:"})," ",e.ip||"N\xe3o informado"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Criada em:"})," ",new Date(e.criadaEm).toLocaleString("pt-BR")]}),(0,r.jsxs)("div",{className:"col-span-2",children:[(0,r.jsx)("strong",{children:"User Agent:"}),(0,r.jsx)("div",{className:"text-xs text-gray-600 mt-1 break-all",children:e.userAgent||"N\xe3o informado"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"\xdaltima Atividade:"})," ",new Date(e.ultimaAtividade).toLocaleString("pt-BR")]})]})]}),(0,r.jsx)("button",{onClick:()=>b(e.id),className:"ml-4 text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600",children:"\uD83D\uDEAB Revogar"})]})},e.id)})})]}),(0,r.jsxs)("div",{className:"rounded-2xl border border-black/10 bg-white p-4 dark:border-white/10 dark:bg-white/5",children:[(0,r.jsx)("h3",{className:"font-semibold text-lg mb-4",children:"Tentativas de Login"}),c?(0,r.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"}),(0,r.jsx)("span",{className:"ml-2",children:"Carregando tentativas..."})]}):0===l.length?(0,r.jsx)("div",{className:"text-gray-500 py-4",children:"Nenhuma tentativa de login registrada."}):(0,r.jsx)("div",{className:"space-y-2",children:l.map(e=>{let s=e.criadaEm?new Date(e.criadaEm):null,a=s&&!isNaN(s.getTime())?s.toLocaleString("pt-BR"):"-";return(0,r.jsx)("div",{className:"border-l-4 pl-4 py-2 ".concat(e.sucesso?"border-green-500 bg-green-50":"border-red-500 bg-red-50"),children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,r.jsx)("span",{className:"w-2 h-2 rounded-full ".concat(e.sucesso?"bg-green-500":"bg-red-500")}),(0,r.jsx)("span",{className:"font-medium ".concat(e.sucesso?"text-green-700":"text-red-700"),children:e.sucesso?"✅ Login bem-sucedido":"❌ Falha no login"}),e.email&&(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:["Email: ",e.email]}),e.ip&&(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:["IP: ",e.ip]}),!e.sucesso&&e.motivoFalha&&(0,r.jsxs)("span",{className:"text-xs rounded bg-red-100 text-red-700 px-2 py-0.5",children:["Motivo: ","INVALID_EMAIL"===e.motivoFalha?"Email inexistente":"INVALID_PASSWORD"===e.motivoFalha?"Senha incorreta":e.motivoFalha]})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:a})]})},e.id)})})]}),(0,r.jsxs)("div",{className:"rounded-2xl border border-black/10 bg-white p-4 dark:border-white/10 dark:bg-white/5",children:[(0,r.jsx)("h3",{className:"font-semibold text-lg mb-4",children:"Informa\xe7\xf5es de Seguran\xe7a"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,r.jsx)("div",{className:"text-sm text-gray-600",children:"Tentativas de Login Falharam"}),(0,r.jsx)("div",{className:"text-lg font-bold text-red-600",children:l.filter(e=>!e.sucesso).length})]}),(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,r.jsx)("div",{className:"text-sm text-gray-600",children:"Sess\xf5es Ativas"}),(0,r.jsx)("div",{className:"text-lg font-bold text-green-600",children:a.length})]}),(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,r.jsx)("div",{className:"text-sm text-gray-600",children:"\xdaltimo Login Bem-sucedido"}),(0,r.jsx)("div",{className:"text-sm font-medium",children:(()=>{let e=null==x?void 0:x.lastSuccessfulLoginAt;if(!e)return"Nenhum login registrado";let s=new Date(e);return isNaN(s.getTime())?"-":s.toLocaleString("pt-BR")})()})]}),(0,r.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,r.jsx)("div",{className:"text-sm text-gray-600",children:"Status da Conta"}),(0,r.jsx)("div",{className:"text-sm font-medium ".concat((null==x?void 0:x.blocked)?"text-red-600":"text-green-600"),children:(null==x?void 0:x.blocked)?"\uD83D\uDD12 Bloqueada":"\uD83D\uDD13 Ativa"})]})]})]})]})}var o=a(30781);async function c(e){let s=await fetch("/api/usuarios/".concat(e,"/auditoria"));if(!s.ok)throw Error("Erro ao carregar auditoria: ".concat(s.status));return s.json()}var u=a(35695),x=a(16447);function m(e){let{id:s}=e,a=(0,u.useRouter)(),{showToast:i}=(0,x.d)(),[m,h]=(0,t.useState)(null),[g,p]=(0,t.useState)("dados"),[b,j]=(0,t.useState)(!1),[N,f]=(0,t.useState)(!0),[v,y]=(0,t.useState)([]),[E,w]=(0,t.useState)(!1),[k,D]=(0,t.useState)(null);async function S(e){j(!0),D(null);try{await (0,o.TK)(s,e),i({title:"Sucesso",message:"Usu\xe1rio atualizado",type:"success"}),a.push("/usuarios")}catch(s){var r;if(null==s?void 0:s.fields)throw s;let e=null!=(r=null==s?void 0:s.message)?r:"Erro ao atualizar usu\xe1rio";D(e),i({title:"Erro",message:e,type:"error"})}finally{j(!1)}}return(0,t.useEffect)(()=>{let e=!0;return f(!0),D(null),(0,o.wz)(s).then(s=>{e&&h(s)}).catch(s=>{e&&D((null==s?void 0:s.message)||"Falha ao carregar usu\xe1rio")}).finally(()=>{e&&f(!1)}),()=>{e=!1}},[s]),(0,t.useEffect)(()=>{"auditoria"===g&&0===v.length&&(w(!0),c(parseInt(s)).then(e=>y(e)).catch(e=>console.error("Erro ao carregar auditoria:",e)).finally(()=>w(!1)))},[g,s,v.length]),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"font-title text-xl",children:"Editar Usu\xe1rio"}),(0,r.jsx)(l(),{href:"/usuarios",className:"rounded-xl border px-3 py-2 text-sm",children:"Voltar"})]}),N&&(0,r.jsx)("div",{className:"rounded-xl border border-black/10 bg-white p-4 text-sm opacity-70 dark:border-white/10 dark:bg-white/5",children:"Carregando…"}),!N&&k&&(0,r.jsx)("div",{className:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:k}),m&&(0,r.jsx)("div",{className:"flex gap-2",children:["dados","permissoes","auditoria","seguranca"].map(e=>(0,r.jsx)("button",{onClick:()=>p(e),className:"rounded-xl px-3 py-2 text-sm ".concat(g===e?"bg-[#0098DA] text-white":"border border-black/10 bg-white dark:border-white/10 dark:bg-white/5"),children:"dados"===e?"Dados":"permissoes"===e?"Permiss\xf5es":"auditoria"===e?"Auditoria":"Seguran\xe7a"},e))}),m&&"dados"===g&&(0,r.jsx)(n.A,{initial:{...m,dataNascimento:"string"==typeof m.dataNascimento?m.dataNascimento:m.dataNascimento?new Date(m.dataNascimento).toISOString().slice(0,10):void 0},onSubmit:S,submitting:b}),"permissoes"===g&&m&&(0,r.jsxs)("div",{className:"rounded-2xl border border-black/10 bg-white p-4 space-y-4 dark:border-white/10 dark:bg-white/5",children:[(0,r.jsx)("h3",{className:"font-semibold text-lg",children:"Permiss\xf5es do Usu\xe1rio"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"N\xedvel/Role:"})," ",m.role||"USUARIO"]}),(0,r.jsx)("div",{className:"px-2 py-1 rounded text-xs font-medium ".concat("ADMIN"===m.role?"bg-red-100 text-red-800":"GERENTE"===m.role?"bg-blue-100 text-blue-800":"FINANCEIRO"===m.role?"bg-green-100 text-green-800":"ESTOQUE"===m.role?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"),children:"ADMIN"===m.role?"Acesso Total":"GERENTE"===m.role?"Gerenciamento":"FINANCEIRO"===m.role?"Financeiro":"ESTOQUE"===m.role?"Estoque":"Usu\xe1rio Padr\xe3o"})]}),(0,r.jsx)("div",{className:"grid grid-cols-2 gap-4",children:Object.entries({Usuários:"usuarios",Financeiro:"financeiro",Clientes:"clientes",Projetos:"projetos",Propostas:"propostas",Estoque:"estoque"}).map(e=>{let[s,a]=e,t=m.role||"USUARIO";return(0,r.jsxs)("div",{className:"p-3 border rounded-lg",children:[(0,r.jsx)("div",{className:"font-medium mb-2",children:s}),(0,r.jsx)("div",{className:"space-y-1 text-xs",children:["read","create","update","delete"].map(e=>{let s=!1;return s="ADMIN"===t||("GERENTE"===t?"usuarios"!==a||"read"===e:"FINANCEIRO"===t?"financeiro"===a||"clientes"===a&&"read"===e||"propostas"===a||"projetos"===a&&"read"===e:"ESTOQUE"===t?"estoque"===a||"projetos"===a&&"read"===e||"clientes"===a&&"read"===e:"clientes"===a||"projetos"===a),(0,r.jsxs)("div",{className:"flex justify-between ".concat(s?"text-green-600":"text-red-500"),children:[(0,r.jsx)("span",{children:"read"===e?"Ler":"create"===e?"Criar":"update"===e?"Editar":"Excluir"}),(0,r.jsx)("span",{children:s?"✓":"✗"})]},e)})})]},a)})})]})]}),"auditoria"===g&&(0,r.jsxs)("div",{className:"rounded-2xl border border-black/10 bg-white p-4 text-sm dark:border-white/10 dark:bg-white/5",children:[(0,r.jsx)("div",{className:"mb-4 font-semibold",children:"Hist\xf3rico de Auditoria"}),E?(0,r.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-blue-600 border-t-transparent"}),(0,r.jsx)("span",{className:"ml-2",children:"Carregando..."})]}):0===v.length?(0,r.jsx)("div",{className:"text-gray-500 py-4",children:"Nenhum log de auditoria encontrado."}):(0,r.jsx)("div",{className:"space-y-2",children:v.map(e=>{let s={CREATE:"Criado",UPDATE:"Atualizado",DELETE:"Exclu\xeddo",LOGIN:"Login realizado",LOGOUT:"Logout realizado"}[e.acao]||e.acao,a={CREATE:"text-green-600",UPDATE:"text-blue-600",DELETE:"text-red-600",LOGIN:"text-purple-600",LOGOUT:"text-gray-600"}[e.acao]||"text-gray-600",t={CREATE:"✅",UPDATE:"\uD83D\uDCDD",DELETE:"\uD83D\uDDD1️",LOGIN:"\uD83D\uDD10",LOGOUT:"\uD83D\uDCE4"}[e.acao]||"\uD83D\uDCCB";return(0,r.jsxs)("div",{className:"border-l-4 border-gray-300 pl-4 py-3 bg-gray-50 rounded-r-lg",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-lg",children:t}),(0,r.jsx)("span",{className:"font-medium ".concat(a),children:s}),(0,r.jsx)("span",{className:"text-gray-400",children:"•"}),(0,r.jsx)("span",{className:"text-gray-700",children:(()=>{if("CREATE"===e.acao)return"Usu\xe1rio criado no sistema";if("UPDATE"===e.acao)return"Dados do usu\xe1rio atualizados";if("LOGIN"===e.acao)return"Realizou login no sistema";if("LOGOUT"===e.acao)return"Saiu do sistema";if("DELETE"===e.acao)return"Usu\xe1rio exclu\xeddo do sistema";return"".concat(s," - ").concat(e.tabela)})()})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:new Date(e.criadoEm).toLocaleString("pt-BR")})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 mt-2 flex items-center gap-4",children:[e.nomeCompleto||e.email?(0,r.jsxs)("span",{children:["\uD83D\uDC64 ",(0,r.jsx)("span",{className:"font-medium text-gray-700",children:e.nomeCompleto||e.email})]}):e.usuarioId?(0,r.jsxs)("span",{children:["\uD83D\uDC64 Usu\xe1rio #",e.usuarioId]}):(0,r.jsx)("span",{children:"\uD83E\uDD16 Sistema"}),e.ip&&(0,r.jsxs)("span",{children:["\uD83C\uDF10 IP: ",e.ip]})]}),e.payload&&(0,r.jsxs)("details",{className:"mt-3",children:[(0,r.jsx)("summary",{className:"text-xs text-blue-600 cursor-pointer hover:text-blue-800 font-medium",children:"\uD83D\uDCCB Ver detalhes t\xe9cnicos"}),(0,r.jsx)("pre",{className:"text-xs bg-gray-100 dark:bg-gray-800 p-3 rounded mt-2 overflow-x-auto border",children:JSON.stringify(JSON.parse(e.payload),null,2)})]})]},e.id)})})]}),"seguranca"===g&&m&&(0,r.jsx)(d,{userId:m.id})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[6874,3395,8441,1684,7358],()=>s(11214)),_N_E=e.O()}]);